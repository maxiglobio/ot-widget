<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Places · Minimal</title>
    <meta name="color-scheme" content="light dark" />
    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" onerror="document.documentElement.dataset.nomap=true">
    <style>
        :root {
            --bg: #fff;
            --fg: #0a0a0a;
            --muted: #707070;
            --card: #fbfbfd;
            --border: #e6e6e6;
            --brand: #0a84ff;
            --ok: #34c759;
            --err: #ff3b30;
            --shadow: 0 1px 2px rgba(0,0,0,.06), 0 8px 30px rgba(0,0,0,.06);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000;
                --fg: #f5f5f7;
                --muted: #9a9aa0;
                --card: #111113;
                --border: #1e1e20;
                --shadow: 0 1px 2px rgba(0,0,0,.3),0 12px 40px rgba(0,0,0,.35);
            }
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            font: 15px/1.6 -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,system-ui;
            background: var(--bg);
            color: var(--fg);
            -webkit-font-smoothing: antialiased
        }

        .wrap {
            max-width: 1000px;
            margin: 0 auto;
            padding: 28px 16px 40px
        }

        header {
            display: flex;
            align-items: center;
            gap: 16px;
            justify-content: space-between;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 18px;
            background: var(--card);
            box-shadow: var(--shadow)
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .title {
            font-weight: 700
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--brand)
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center
        }

        input[type="url"], input[type="text"], input[type="number"] {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--fg);
            outline: none;
            min-width: 240px
        }

        input:focus {
            border-color: color-mix(in oklab, var(--brand) 60%, var(--border))
        }

        .chk {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: transparent
        }

        button {
            appearance: none;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--fg);
            color: var(--bg);
            font-weight: 600;
            cursor: pointer
        }

            button.ghost {
                background: transparent;
                color: var(--fg)
            }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

        main {
            margin-top: 18px;
            display: grid;
            gap: 16px
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px
        }

        @media(min-width:880px) {
            .grid {
                grid-template-columns: 390px 1fr
            }
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 18px;
            background: var(--card);
            box-shadow: var(--shadow);
            overflow: clip
        }

            .card .hd {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 14px;
                border-bottom: 1px solid var(--border)
            }

            .card .label {
                font-weight: 600
            }

        .badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--muted)
        }

            .badge.ok {
                color: var(--ok);
                border-color: color-mix(in oklab, var(--ok) 50%, var(--border))
            }

            .badge.err {
                color: var(--err);
                border-color: color-mix(in oklab, var(--err) 50%, var(--border))
            }

        .body {
            padding: 14px
        }

        .row {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .map {
            height: 280px;
            border-radius: 14px;
            border: 1px solid var(--border)
        }

        [data-nomap] .mapwrap {
            display: none
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size: 13px
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word
        }

        .kv {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 10px 16px
        }

        .muted {
            color: var(--muted)
        }

        .pill {
            display: inline-block;
            padding: 4px 10px;
            border: 1px solid var(--border);
            border-radius: 999px;
            font-size: 12px;
            margin: 2px 6px 2px 0
        }

        .split {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .tabs {
            display: flex;
            gap: 8px
        }

            .tabs button {
                background: transparent;
                color: var(--fg)
            }

                .tabs button.active {
                    background: var(--fg);
                    color: var(--bg)
                }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--brand);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <div class="brand"><span class="dot"></span><div class="title">Place Finder</div></div>
            <div class="controls">
                <input id="endpoint" type="url" placeholder="https://localhost:5001/api/Place" aria-label="Endpoint URL" style="min-width:320px">
                <button id="save" class="ghost" title="Зберегти URL">Зберегти URL</button>
            </div>
        </header>

        <main class="grid">
            <section class="card">
                <div class="hd"><div class="label">Параметри запиту</div><span id="status" class="badge">Готово</span></div>
                <div class="body">
                    <div class="row split">
                        <label class="muted">Lat<input id="lat" type="number" step="any" placeholder="36.54" /></label>
                        <label class="muted">Lng<input id="lng" type="number" step="any" placeholder="31.99" /></label>
                        <label class="chk"><input id="kids" type="checkbox" checked><span>Kids</span></label>
                        <label class="chk"><input id="pets" type="checkbox" checked><span>Pets</span></label>
                        <label class="chk"><input id="car" type="checkbox" checked><span>Car</span></label>
                    </div>
                    <div class="row" style="margin-top:10px">
                        <input id="exclude" type="text" placeholder="excludeIds (через кому): a1,b2,c3" style="flex:1; min-width:100%">
                    </div>

                    <div class="mapwrap" style="margin-top:12px">
                        <div id="map" class="map" aria-label="Карта для вибору координат"></div>
                        <div class="muted" style="margin-top:6px">Клік по карті встановлює Lat/Lng · <button id="geo" class="ghost" type="button">Взяти моє місцезнаходження</button></div>
                    </div>

                    <div class="row" style="justify-content: flex-end; margin-top:12px; gap:8px">
                        <button id="clear" class="ghost">Очистити</button>
                        <button id="send">Завантажити</button>
                        <span id="loader" class="spinner" style="display:none"></span>
                    </div>
                </div>
            </section>

            <section class="card" aria-live="polite">
                <div class="hd">
                    <div class="label">Результат</div>
                    <div class="tabs">
                        <button id="tabView" class="active">Вигляд</button>
                        <button id="tabJson">JSON</button>
                    </div>
                </div>
                <div class="body">
                    <div id="view"></div>
                    <pre id="json" class="mono" style="display:none">Натисніть «Завантажити», щоб отримати дані…</pre>
                </div>
            </section>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous" onerror="console.warn('Leaflet недоступний')"></script>
    <script>
        const qs = s => document.querySelector(s);
        const $endpoint = qs('#endpoint');
        const $lat = qs('#lat');
        const $lng = qs('#lng');
        const $kids = qs('#kids');
        const $pets = qs('#pets');
        const $car = qs('#car');
        const $exclude = qs('#exclude');
        const $status = qs('#status');
        const $view = qs('#view');
        const $json = qs('#json');
        const $loader = qs('#loader');
        const $send = qs('#send');

        const KEY = 'place:endpoint';
        const prettify = (x) => { try { return JSON.stringify(typeof x === 'string' ? JSON.parse(x) : x, null, 2) } catch { return String(x) } }
        const setStatus = (t, k = '') => { $status.textContent = t; $status.className = 'badge ' + k };

        // Tabs
        qs('#tabView').onclick = () => { qs('#tabView').classList.add('active'); qs('#tabJson').classList.remove('active'); $view.style.display = ''; $json.style.display = 'none' };
        qs('#tabJson').onclick = () => { qs('#tabJson').classList.add('active'); qs('#tabView').classList.remove('active'); $view.style.display = 'none'; $json.style.display = '' };

        // Endpoint init: saved -> default(origin/api/Place) -> query override
        const saved = localStorage.getItem(KEY);
        $endpoint.value = saved || `${window.location.origin}/api/Place`;
        const u = new URL(location.href);
        const fromQuery = u.searchParams.get('url');
        if (fromQuery) $endpoint.value = fromQuery;

        // Save button
        qs('#save').onclick = () => { localStorage.setItem(KEY, $endpoint.value.trim()); setStatus('URL збережено', 'ok'); setTimeout(() => setStatus('Готово'), 1200) }

        // Map init (if Leaflet loaded)
        let map, marker;
        if (!document.documentElement.dataset.nomap && window.L) {
            const defaultLat = parseFloat($lat.value) || 36.54; const defaultLng = parseFloat($lng.value) || 31.99;
            map = L.map('map', { zoomControl: false }).setView([defaultLat, defaultLng], 12);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OSM' }).addTo(map);
            marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);
            const setPos = (lat, lng) => { $lat.value = lat.toFixed(6); $lng.value = lng.toFixed(6); marker.setLatLng([lat, lng]); };
            map.on('click', e => setPos(e.latlng.lat, e.latlng.lng));
            marker.on('moveend', e => setPos(e.target.getLatLng().lat, e.target.getLatLng().lng));
            qs('#geo').onclick = () => { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(p => { const { latitude, longitude } = p.coords; map.setView([latitude, longitude], 14); setPos(latitude, longitude); }, () => setStatus('Гео недоступна', 'err')); } };
        }

        qs('#clear').onclick = () => { $exclude.value = ''; setStatus('Очищено'); setTimeout(() => setStatus('Готово'), 1000) };

        function buildBody() {
            const lat = parseFloat($lat.value); const lng = parseFloat($lng.value);
            const excludeIds = $exclude.value.split(',').map(s => s.trim()).filter(Boolean);
            return { lat: isFinite(lat) ? lat : 0, lng: isFinite(lng) ? lng : 0, kids: $kids.checked, pets: $pets.checked, car: $car.checked, excludeIds };
        }

        function renderView(o) {
            if (!o || typeof o !== 'object') { $view.innerHTML = '<span class="muted">Порожньо</span>'; return; }
            const bool = v => v ? 'Так' : 'Ні';
            const m = (o.distanceMeters ?? 0);
            const dist = m >= 1000 ? (m / 1000).toFixed(2) + ' км' : m + ' м';
            const cats = Array.isArray(o.categories) ? o.categories : [];
            $view.innerHTML = `
            <div class="kv">
              <div class="muted">Назва</div><div>${o.name ?? ''}</div>
              <div class="muted">Адреса</div><div>${o.address ?? ''}</div>
              <div class="muted">Координати</div><div>${(o.latitude ?? '')}, ${(o.longitude ?? '')}</div>
              <div class="muted">Дистанція</div><div>${dist}</div>
              <div class="muted">Рейтинг</div><div>${o.rating ?? '—'}</div>
              <div class="muted">Популярність</div><div>${o.popularity ?? '—'}</div>
              <div class="muted">Kids</div><div>${bool(o.kids)}</div>
              <div class="muted">Pets</div><div>${bool(o.pets)}</div>
              <div class="muted">Car</div><div>${bool(o.car)}</div>
              <div class="muted">Категорія</div><div>${o.category ?? ''}</div>
              <div class="muted">Тайтл</div><div>${o.title ?? ''}</div>
              <div class="muted">Опис</div><div>${o.description ?? ''}</div>
              <div class="muted">Теги</div><div>${o.tags ?? ''}</div>
              <div class="muted">Google Maps</div><div>${o.googleMapLink ? `<a href="${o.googleMapLink}" target="_blank" rel="noopener">Відкрити</a>` : '—'}</div>
              <div class="muted">Apple Maps</div><div>${o.appleMapLink ? `<a href="${o.appleMapLink}" target="_blank" rel="noopener">Відкрити</a>` : '—'}</div>
              <div class="muted">Категорії</div><div>${cats.length ? cats.map(c => `<span class="pill">${c}</span>`).join(' ') : '—'}</div>
              <div class="muted">ID</div><div>${o.id ?? ''}</div>
            </div>`;
        }

        async function send() {
            const url = $endpoint.value.trim(); if (!url) { setStatus('Вкажіть URL'); return; }
            const body = buildBody();
            setStatus('Надсилаю…');
            $loader.style.display = '';
            $send.disabled = true;

            try {
                const res = await fetch(url, { method: 'POST', headers: { 'Accept': 'application/json, text/plain;q=0.9', 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const ct = res.headers.get('content-type') || ''; let data;
                if (ct.includes('application/json')) data = await res.json(); else data = JSON.parse(await res.text());
                $json.textContent = prettify(data);
                renderView(data);
                setStatus('OK ' + res.status, 'ok');
            } catch (e) {
                $json.textContent = e?.message || 'Помилка';
                $view.innerHTML = '<span class="muted">Помилка запиту</span>';
                setStatus('Помилка', 'err');
            } finally {
                $loader.style.display = 'none';
                $send.disabled = false;
            }
        }

        $send.onclick = send;
    </script>
</body>
</html>
