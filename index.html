<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>One Thing</title>

<!-- Import Manrope font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap"
  rel="stylesheet">

<!-- MAPBOX CSS & JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<!-- Include Lottie player for the button animation -->
<script>
  // Prevent duplicate lottie-player registrationimage.png
  if (!customElements.get('lottie-player')) {
    const script = document.createElement('script');
    script.src = "https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js";
    document.head.appendChild(script);
  }
</script>

<!-- Include HEIC to JPEG converter -->
<script src="https://unpkg.com/heic2any@0.2.2/dist/heic2any.min.js"></script>

<style>
  /* Reset and base styles for iframe compatibility */
  html,
  body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow-x: hidden;
    box-sizing: border-box;
    background-color: #F7F7F7;
  }

  * {
    box-sizing: border-box;
  }

  /* Global font family */
  * {
    font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }

  /* Ensure buttons and interactive elements use Manrope */
  button,
  input,
  select,
  textarea {
    font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }

  /* Ensure popup elements use Manrope */
  .one-thing-popup h3,
  .one-thing-popup p,
  .confirmation-popup h3,
  .confirmation-popup p,
  .referral-popup h3,
  .referral-popup p {
    font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }

  /* Ensure card elements use Manrope */
  .one-thing-card h4,
  .one-thing-card p,
  .card-category-tag,
  .card-expiry,
  .complete-thing-btn {
    font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }

  /* Ensure filter and dropdown elements use Manrope */
  .filter-buttons button,
  .dropdown-trigger,
  .dropdown-item,
  .toggle-label {
    font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }

  /* Ensure all UI elements use Manrope */
  #attempts-counter,
  .empty-state h3,
  .empty-state p,
  .empty-state-btn,
  .success-tooltip {
    font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }

  /* User Profile Section Styles */
  .user-profile-section {
    position: relative;
    width: 100vw;
    height: 400px;
    margin: 0;
    margin-bottom: 40px;
    overflow: hidden;
    margin-left: calc(-50vw + 50%);
  }

  /* Map Background */
  .map-hero-wrapper {
    position: relative;
    height: 100%;
    width: 100%;
    overflow: hidden;
  }

  .map-background {
    height: 100%;
    width: 100%;
    position: absolute;
    z-index: 0;
  }

  .map-overlay-gradient {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, rgba(247, 247, 247, 0) 0%, rgba(247, 247, 247, 0.3) 40%, rgba(247, 247, 247, 0.7) 70%, #F7F7F7 100%);
    z-index: 1;
    pointer-events: none;
  }

  /* User Avatar */
  .user-avatar-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    text-align: center;
  }

  .user-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    object-fit: cover;
    object-position: center;
    background: #f0f0f0;
    display: block;
  }

  /* Location Section - Top Left */
  .location-section {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 10;
  }

  .globio-nav-wrapper {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: 0;
    background: transparent;
    z-index: 0;
  }

  .globio-nav-inner {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 999px;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    padding: 12px 16px 12px 16px;
    max-width: 100%;
    box-sizing: border-box;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  #location-text {
    font-size: 16px;
    line-height: 1.5;
    font-weight: 600;
    margin: 0;
    color: #707070;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #location-text .location-prefix {
    color: #707070;
    font-weight: 500;
  }

  #location-text .location-name {
    color: #000000;
    font-weight: 600;
  }

  #location-clickable {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }

  #location-detect {
    color: #000000;
    font-weight: 600;
  }

  #location-clickable img,
  #mobile-pin {
    width: 34px;
    height: 34px;
    pointer-events: none;
  }

  #mobile-pin {
    display: none;
    cursor: pointer;
    pointer-events: auto;
  }

  /* User Menu Section - Top Right */
  .user-menu-section {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 10;
  }

  .user-menu-button {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 999px;
    padding: 12px 16px;
    height: 58px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.2s ease;
  }

  .user-menu-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  }

  .user-menu-button img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
  }


  .user-menu-button .user-name {
    font-size: 16px;
    font-weight: 600;
    color: #141414;
  }

  .user-level-badge {
    font-size: 12px;
    font-weight: 600;
    color: #B1E530;
    background: rgba(177, 229, 48, 0.1);
    padding: 2px 8px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid rgba(177, 229, 48, 0.2);
  }

  .user-level-badge:hover {
    background: rgba(177, 229, 48, 0.2);
    transform: scale(1.05);
  }

  .user-divider {
    width: 3px;
    height: 20px;
    background: #d0d0d0;
    border-radius: 2px;
    margin: 0 8px;
  }


  .user-menu-button .dropdown-arrow {
    width: 16px;
    height: 16px;
    transition: transform 0.2s ease;
  }

  .user-menu-button:hover .dropdown-arrow {
    transform: rotate(180deg);
  }

  /* User Dropdown Menu */
  .user-dropdown {
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 24px;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
    padding: 12px;
    min-width: 260px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
  }

  .user-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .user-dropdown-header {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 6px;
  }

  .user-dropdown-header .user-email {
    font-size: 14px;
    color: #666;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .user-dropdown-header .user-email svg {
    color: #666;
    opacity: 0.7;
    flex-shrink: 0;
  }

  .user-dropdown-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    border-radius: 14px;
    cursor: pointer;
    transition: background 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    color: #141414;
    justify-content: flex-start;
  }

  .user-dropdown-item:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  .user-dropdown-item svg {
    width: 16px;
    height: 16px;
    opacity: 0.7;
    color: #666;
    flex-shrink: 0;
  }

  /* My Context Modal */
  .my-context-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .my-context-modal.show {
    opacity: 1;
    visibility: visible;
  }

  .my-context-content {
    background: white;
    border-radius: 24px;
    padding: 40px;
    max-width: 700px;
    width: 90%;
    text-align: center;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    transform: scale(0.9) translateY(20px);
    transition: all 0.3s ease;
  }

  .my-context-modal.show .my-context-content {
    transform: scale(1) translateY(0);
  }

  .my-context-title {
    font-size: 28px;
    font-weight: 700;
    margin-top: 0;
    margin-bottom: 16px;
    color: #141414;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .my-context-description {
    font-size: 16px;
    line-height: 1.5;
    color: #666;
    margin-bottom: 32px;
  }

  .close-modal {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s ease;
  }

  .close-modal svg {
    width: 24px;
    height: 24px;
    color: #666;
    transition: color 0.2s ease;
  }

  .close-modal:hover svg {
    color: #000;
  }

  /* Switch Options */
  .switch-row {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-bottom: 32px;
    flex-wrap: wrap;
  }

  .switch-card {
    background: rgba(0,0,0,0.05);
    border-radius: 30px;
    padding: 12px 32px 20px 32px;
    text-align: center;
    transition: background 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .switch-card:hover {
    background: rgba(0,0,0,0.1);
  }

  .switch-card svg {
    color: #666;
    opacity: 0.8;
  }

  .switch-label {
    color: #000000;
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 12px;
  }

  /* iOS-style Switch */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    background-color: #ccc;
    border-radius: 34px;
    top: 0; left: 0; right: 0; bottom: 0;
    transition: .4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #B1E530;
  }

  input:checked + .slider:before {
    transform: translateX(22px);
  }

  .save-changes-btn {
    background: #333;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 16px 32px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .save-changes-btn:hover {
    background: #444;
    transform: translateY(-2px);
  }

  /* Mobile Responsiveness */
  @media screen and (max-width: 600px) {
    .user-profile-section {
      height: 300px;
      margin-bottom: 20px;
    }

    .location-section {
      top: 20px;
      left: 20px;
    }

    .user-menu-section {
      top: 20px;
      right: 20px;
    }

    .globio-nav-inner {
      padding: 12px 16px;
      height: 48px;
      display: flex;
      align-items: center;
    }

    .user-menu-button {
      height: 58px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #location-text,
    #location-clickable img:not(#mobile-pin),
    #location-detect {
      display: none !important;
    }

    #mobile-pin {
      display: inline-block;
    }

    .user-menu-button .user-name {
      display: inline;
      font-size: 14px;
      font-weight: 500;
    }

    .user-level-badge {
      font-size: 10px;
      padding: 1px 6px;
    }

    .user-divider {
      width: 2px;
      height: 16px;
      margin: 0 6px;
    }

    .user-menu-button img {
      display: none;
    }

    .user-menu-button .dropdown-arrow {
      width: 14px;
      height: 14px;
    }

    .user-avatar {
      width: 56px;
      height: 56px;
    }

    .location-section {
      top: 15px;
      left: 15px;
    }

    .user-menu-section {
      top: 15px;
      right: 15px;
    }

    .user-dropdown {
      min-width: 240px;
      right: -20px;
    }

    .user-dropdown-item svg {
      width: 14px;
      height: 14px;
    }

    .my-context-content {
      padding: 24px;
      margin: 20px;
    }

    .my-context-title svg {
      width: 20px;
      height: 20px;
    }

    .switch-card {
      padding: 8px 24px 16px 24px;
    }

    .switch-card svg {
      width: 24px;
      height: 24px;
    }

    .switch-label {
      font-size: 18px;
    }

    .switch {
      width: 42px;
      height: 24px;
    }

    .slider:before {
      width: 18px;
      height: 18px;
      left: 3px;
      bottom: 3px;
    }

    input:checked + .slider:before {
      transform: translateX(18px);
    }
  }

  /* Container to center the button and filters */
  #one-thing-account-component {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    margin: 0;
    padding: 0;
    width: 100%;
    min-height: 100vh;
    text-align: center;
    position: relative;
    box-sizing: border-box;
    background-color: #F7F7F7;
  }

  /* Ensure popups are positioned relative to viewport, not iframe */
  body {
    overflow-x: hidden;
  }

  /* Force popups to be positioned relative to viewport */
  .one-thing-popup,
  .confirmation-popup,
  .referral-popup {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 999999 !important;
  }

  /* Circular button styled like your original design */
  .one-thing-account-btn {
    position: relative;
    width: 185px;
    height: 185px;
    border-radius: 50%;
    background: #ffffff;
    box-shadow:
      0 8px 24px rgba(0, 0, 0, 0.1),
      inset -4px -9px 3px rgba(0, 0, 0, 0),
      inset -2px -6px 2px rgba(0, 0, 0, 0.01),
      inset -1px -3px 2px rgba(0, 0, 0, 0.03),
      inset -1px -1px 2px rgba(0, 0, 0, 0.05),
      inset 0 0 1px rgba(0, 0, 0, 0.06);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease;
    animation: softPulse 3s ease-in-out infinite;
  }

  .one-thing-account-btn.loading {
    pointer-events: none;
  }

  .one-thing-account-btn.inactive {
    cursor: not-allowed;
    opacity: 0.6;
    animation: none;
    pointer-events: none;
  }

  .one-thing-account-btn.inactive lottie-player {
    filter: grayscale(100%);
  }

  /* Spinner ring appears only when loading */
  .spinner-ring-account {
    position: absolute;
    width: 185px;
    height: 185px;
    border-radius: 50%;
    border: 4px solid transparent;
    border-top: 4px solid #B1E530;
    border-right: 4px solid #ffffff;
    animation: spin 1s linear infinite;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  .one-thing-account-btn.loading .spinner-ring-account {
    opacity: 1;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }

  @keyframes softPulse {

    0%,
    100% {
      transform: scale(1);
      box-shadow:
        0 8px 24px rgba(0, 0, 0, 0.1),
        inset -4px -9px 3px rgba(0, 0, 0, 0),
        inset -2px -6px 2px rgba(0, 0, 0, 0.01),
        inset -1px -3px 2px rgba(0, 0, 0, 0.03),
        inset -1px -1px 2px rgba(0, 0, 0, 0.05),
        inset 0 0 1px rgba(0, 0, 0, 0.06);
    }

    50% {
      transform: scale(1.05);
      box-shadow:
        0 12px 32px rgba(0, 0, 0, 0.15),
        inset -4px -9px 3px rgba(0, 0, 0, 0),
        inset -2px -6px 2px rgba(0, 0, 0, 0.01),
        inset -1px -3px 2px rgba(0, 0, 0, 0.03),
        inset -1px -1px 2px rgba(0, 0, 0, 0.05),
        inset 0 0 1px rgba(0, 0, 0, 0.06);
    }
  }

  /* Attempts counter */
  #attempts-counter {
    margin-top: 16px;
    font-size: 14px;
    color: #141414;
    display: inline-block;
  }

  #attempts-counter.no-attempts {
    color: #999;
  }

  /* Filters styled to match your screenshot */
  .filter-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 32px;
    width: 100%;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
    padding: 0 20px;
    box-sizing: border-box;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .filter-divider {
    width: 2px;
    height: 20px;
    background: #E0E0E0;
    border-radius: 1px;
    margin: 0 4px;
  }

  .filter-buttons button {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: 1px solid #E6E6E6;
    background: transparent;
    border-radius: 999px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 600;
    color: #808080;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 100px;
    justify-content: center;
  }

  .filter-buttons button img {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    opacity: 0.5;
    transition: opacity 0.2s ease;
  }

  .filter-buttons button:hover {
    background: rgba(0, 0, 0, 0.05);
    transform: translateY(-1px);
  }

  .filter-buttons button.active {
    color: #141414;
  }

  .filter-buttons button.active img {
    opacity: 1;
  }

  /* All Categories Dropdown Styles */
  .dropdown-container {
    position: relative;
    display: inline-block;
  }

  .dropdown-trigger {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: 1px solid #E6E6E6;
    background: transparent;
    border-radius: 999px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 600;
    color: #999;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 100px;
    justify-content: center;
  }

  .dropdown-trigger:hover {
    background: rgba(0, 0, 0, 0.05);
    transform: translateY(-1px);
  }

  .dropdown-trigger.active {
    color: #141414;
  }

  .dropdown-trigger.active svg {
    stroke: #141414;
  }

  .dropdown-arrow {
    transition: transform 0.3s ease;
    stroke: #999;
  }

  .dropdown-trigger.active .dropdown-arrow {
    transform: rotate(180deg);
    stroke: #141414;
  }



  .dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    background: #ffffff;
    border-radius: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    padding: 12px;
    min-width: 200px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
  }

  .dropdown-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 16px;
    cursor: pointer;
    transition: background 0.2s ease;
    font-size: 14px;
    font-weight: 600;
    color: #141414;
  }

  .dropdown-item:hover {
    background: #f8f8f8;
  }

  .dropdown-item.selected {
    background: #E6F5D8;
    color: #141414;
    font-weight: 600;
  }

  .category-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .category-indicator.daily {
    background: #AAB40F;
  }

  .category-indicator.places {
    background: #58AD95;
  }

  .category-indicator.local {
    background: #A670BC;
  }

  .category-indicator.all {
    background: #9E9E9E;
  }

  /* Saved/completed cards grid */
  #one-thing-card-list {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    width: 100%;
    max-width: 1200px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin: 40px auto;
    padding: 0 20px;
    box-sizing: border-box;
  }

  /* Card styling */
  .one-thing-card {
    background: #ffffff;
    border: 1px solid #E6E6E6;
    border-radius: 24px;
    padding: 24px;
    display: flex;
    flex-direction: column;
    position: relative;
    min-height: 320px;
    justify-content: space-between;
    width: 100%;
    box-sizing: border-box;
  }


  /* Category tag */
  .card-category-tag {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 16px;
    align-self: center;
    border: 1px solid;
  }

  .card-category-tag.daily,
  .card-category-tag.DAILY {
    background: transparent;
    color: #AAB40F;
    border: 1.5px solid rgba(170, 180, 15, 0.3);
  }

  .card-category-tag.places,
  .card-category-tag.PLACES {
    background: transparent !important;
    color: #58AD95 !important;
    border: 1.5px solid rgba(88, 173, 149, 0.3) !important;
  }

  .card-category-tag.local,
  .card-category-tag.LOCAL {
    background: transparent;
    color: #A670BC;
    border: 1.5px solid rgba(166, 112, 188, 0.3);
  }

  .card-category-tag.daily-things,
  .card-category-tag.DAILY-THINGS {
    background: transparent;
    color: #AAB40F;
    border: 1.5px solid rgba(170, 180, 15, 0.3);
  }

  .card-category-tag.local-context,
  .card-category-tag.LOCAL-CONTEXT {
    background: transparent;
    color: #A670BC;
    border: 1.5px solid rgba(166, 112, 188, 0.3);
  }

  /* Image placeholder */
  .card-image-placeholder {
    width: 100%;
    max-width: 190px;
    height: 190px;
    border: none;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
    cursor: pointer;
    background: transparent;
    position: relative;
    overflow: hidden;
    align-self: center;
    transition: all 0.3s ease;
  }





  .card-image-placeholder img {
    width: 190px;
    height: 190px;
    object-fit: cover;
    border-radius: 16px;
  }

  .card-image-placeholder .uploaded-image {
    width: 180px;
    height: 180px;
    border-radius: 20px;
  }

  .card-image-placeholder .add-photo-icon {
    width: 190px;
    height: 190px;
    opacity: 0.8;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .card-image-placeholder:hover .add-photo-icon {
    filter: brightness(0.95);
    transform: scale(1.01);
  }

  .card-image-placeholder:active .add-photo-icon {
    filter: brightness(0.88);
    transform: scale(0.99);
  }





  .card-image-placeholder input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  /* Card content */
  .one-thing-card h4 {
    margin: 0 0 12px 0;
    font-size: 18px;
    font-weight: 700;
    line-height: 1.3;
    color: #333;
    text-align: left;
  }

  .one-thing-card p {
    font-size: 14px;
    line-height: 1.5;
    margin: 0 0 16px 0;
    color: #666;
    font-weight: 500;
    text-align: left;
  }

  .card-expiry {
    font-size: 12px;
    color: #888;
    margin-top: auto;
    text-align: center;
    padding: 8px 16px;
    background: #ffffff;
    border-radius: 999px;
    border: 1px solid #E0E0E0;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    align-self: center;
    width: fit-content;
    min-width: fit-content;
  }

  /* Color indicators for urgency */
  .card-expiry.warning {
    color: #FF8C00;
    border-color: #FF8C00;
  }

  .card-expiry.critical {
    color: #FF4444;
    border-color: #FF4444;
    background: #FFF5F5;
  }

  .card-author {
    font-size: 12px;
    color: #666;
    margin-top: 8px;
    text-align: center;
    font-style: italic;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .author-avatar {
    border-radius: 50%;
    object-fit: cover;
    object-position: center;
    display: block;
  }

  /* Image upload loader */
  .image-upload-loader {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 16px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 10;
  }

  .image-upload-loader.show {
    opacity: 1;
    visibility: visible;
  }

  .image-upload-loader .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #B1E530;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .image-upload-loader .loading-text {
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    color: #666;
    font-weight: 500;
  }

  .complete-thing-btn {
    background: #B1E530;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    margin-top: auto;
    text-align: center;
    box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
    width: auto;
    min-width: 120px;
    align-self: center;
  }



  /* Referral popup */
  .referral-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .referral-popup.show {
    opacity: 1;
    visibility: visible;
  }

  .referral-popup-inner {
    background: #ffffff;
    border-radius: 20px;
    padding: 32px;
    max-width: 480px;
    width: 95%;
    text-align: center;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    transform: scale(0.9) translateY(20px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .referral-popup.show .referral-popup-inner {
    transform: scale(1) translateY(0);
  }

  .referral-popup h3 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 16px;
    color: #333;
  }

  .referral-popup p {
    font-size: 16px;
    line-height: 1.5;
    margin-bottom: 24px;
    color: #666;
  }

  .referral-link-container {
    background: #f8f8f8;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .referral-link {
    font-family: monospace;
    font-size: 14px;
    color: #999;
    word-break: break-all;
    flex: 1;
  }

  .referral-link .highlight {
    color: #333;
    font-weight: 600;
  }

  .copy-btn {
    background: #B1E530;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .copy-btn:hover {
    background: #B1E530;
    transform: translateY(-1px);
  }

  .copy-btn.copied {
    background: #666;
  }

  .referral-popup-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .referral-popup button {
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
  }

  .referral-popup .btn-secondary {
    background: #f8f8f8;
    color: #666;
    border: 1px solid #e0e0e0;
  }

  .referral-popup .btn-secondary:hover {
    background: #f0f0f0;
  }

  /* Empty state */
  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    margin-top: 40px;
    color: #666;
  }

  .empty-state img {
    width: auto;
    height: 150px;
    margin-bottom: 20px;
  }

  .empty-state h3 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 12px;
    color: #333;
  }

  .empty-state p {
    font-size: 16px;
    line-height: 1.5;
    margin-bottom: 24px;
    color: #666;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }

  .empty-state-btn {
    display: none;
    background: #f8f8f8;
    border: 1px solid #e0e0e0;
    border-radius: 24px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .empty-state-btn:hover {
    background: #f0f0f0;
    transform: translateY(-1px);
  }

  /* Tablet adjustments */
  @media (max-width: 900px) and (min-width: 601px) {
    #one-thing-card-list {
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      max-width: 800px;
    }

    .filter-buttons {
      flex-wrap: wrap;
      gap: 16px;
    }
  }

  /* Medium mobile adjustments */
  @media (max-width: 500px) and (min-width: 401px) {
    .filter-buttons {
      gap: 10px;
    }

    .filter-group {
      gap: 10px;
    }

    .filter-buttons button {
      min-width: 52px;
      height: 52px;
      padding: 14px;
    }

    .filter-buttons button img {
      width: 22px;
      height: 22px;
    }

    .dropdown-trigger {
      min-width: 130px;
      height: 52px;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dropdown-trigger {
      border-radius: 26px;
    }

    .dropdown-trigger svg {
      width: 18px;
      height: 18px;
    }
  }

  /* Mobile adjustments */
  @media (max-width: 600px) {
    #one-thing-account-component {
      padding: 0;
    }

    #one-thing-card-list {
      grid-template-columns: 1fr;
      padding: 0 20px;
      gap: 16px;
      margin: 20px auto;
    }

    .one-thing-account-btn {
      width: 140px;
      height: 140px;
    }

    .spinner-ring-account {
      width: 140px;
      height: 140px;
    }

    .one-thing-account-btn lottie-player {
      width: 80px !important;
      height: 80px !important;
    }

    .filter-buttons {
      flex-direction: row;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 100%;
      padding: 0 20px;
    }

    .filter-group {
      flex-direction: row;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      width: auto;
    }

    .filter-buttons button {
      width: auto;
      min-width: 48px;
      height: 48px;
      padding: 12px;
      justify-content: center;
      border-radius: 50%;
    }

    .filter-buttons button span {
      display: none;
    }

    .dropdown-trigger span {
      display: inline !important;
    }

    .filter-buttons button img {
      width: 20px;
      height: 20px;
      margin: 0;
    }

    .dropdown-trigger {
      width: auto;
      min-width: 120px;
      height: 48px;
      padding: 12px 16px;
      justify-content: space-between;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
    }



    .dropdown-trigger svg {
      width: 16px;
      height: 16px;
    }

    .dropdown-menu {
      min-width: 160px;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
    }

    .dropdown-menu.show {
      transform: translateX(-50%) translateY(0);
    }

    .filter-divider {
      width: 2px;
      height: 20px;
      background: #E0E0E0;
      border-radius: 1px;
      margin: 0 4px;
    }
  }

  /* Extra small screens */
  @media (max-width: 400px) {
    #one-thing-account-component {
      padding: 0;
    }

    #one-thing-card-list {
      padding: 0 15px;
      gap: 12px;
    }

    .filter-buttons {
      padding: 0 15px;
      gap: 6px;
    }

    .filter-group {
      gap: 6px;
    }

    .filter-buttons button {
      min-width: 44px;
      height: 44px;
      padding: 10px;
    }

    .filter-buttons button img {
      width: 18px;
      height: 18px;
    }

    .dropdown-trigger {
      min-width: 100px;
      height: 44px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
    }

    .dropdown-trigger span {
      display: inline !important;
    }

    .dropdown-trigger svg {
      width: 14px;
      height: 14px;
    }

    .dropdown-menu {
      min-width: 140px;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
    }

    .dropdown-menu.show {
      transform: translateX(-50%) translateY(0);
    }

    .one-thing-card {
      padding: 16px;
      min-height: 280px;
    }

    .card-image-placeholder {
      max-width: 150px;
      height: 150px;
    }

    .card-image-placeholder .add-photo-icon {
      width: 150px;
      height: 150px;
    }

    .one-thing-account-btn {
      width: 120px;
      height: 120px;
    }

    .spinner-ring-account {
      width: 120px;
      height: 120px;
    }

    .one-thing-account-btn lottie-player {
      width: 60px !important;
      height: 60px !important;
    }
  }

  /* Card Popup Styles */
  .one-thing-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .one-thing-popup.show {
    opacity: 1;
    visibility: visible;
  }

  .one-thing-popup-inner {
    background: #ffffff;
    border-radius: 30px;
    padding: 8px 8px 32px 8px;
    width: 90%;
    max-width: 380px;
    max-height: 80vh;
    overflow-y: auto;
    text-align: center;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    transform: scale(0.9) translateY(20px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 32px;
  }

  .popup-content-wrapper {
    display: flex;
    padding: 24px;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    align-self: stretch;
    border-radius: 24px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    background: #FFF;
    box-shadow: 0 45px 13px 0 rgba(0, 0, 0, 0.00), 0 29px 12px 0 rgba(0, 0, 0, 0.01), 0 16px 10px 0 rgba(0, 0, 0, 0.02), 0 7px 7px 0 rgba(0, 0, 0, 0.03), 0 2px 4px 0 rgba(0, 0, 0, 0.04);
    gap: 16px;
  }

  .one-thing-popup.show .one-thing-popup-inner {
    transform: scale(1) translateY(0);
  }

  /* Category pill */
  .popup-category-pill {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    margin: 0;
    position: relative;
    z-index: 1;
  }

  .popup-category-pill.daily {
    background: transparent !important;
    color: #AAB40F !important;
    border: 1.5px solid rgba(170, 180, 15, 0.3) !important;
  }

  .popup-category-pill.places {
    background: transparent !important;
    color: #58AD95 !important;
    border: 1.5px solid rgba(88, 173, 149, 0.3) !important;
  }

  .popup-category-pill.local {
    background: transparent !important;
    color: #A670BC !important;
    border: 1.5px solid rgba(166, 112, 188, 0.3) !important;
  }

  .popup-category-pill.daily-things {
    background: transparent !important;
    color: #AAB40F !important;
    border: 1.5px solid rgba(170, 180, 15, 0.3) !important;
  }

  .popup-category-pill.local-context {
    background: transparent !important;
    color: #A670BC !important;
    border: 1.5px solid rgba(166, 112, 188, 0.3) !important;
  }

  /* Category icon */
  .popup-category-icon {
    margin: 0;
  }

  .popup-category-icon img {
    width: 484px;
    height: 240px;
    object-fit: contain;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
    margin: -60px -121px;
    position: relative;
  }

  /* Title and description */
  .one-thing-popup-inner h3 {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 8px 0;
    color: #333;
    line-height: 1.3;
    text-align: left;
    position: relative;
    z-index: 1;
  }

  .one-thing-popup-inner p {
    font-size: 16px;
    line-height: 1.6;
    color: #333;
    margin: 0;
    font-weight: 400;
    text-align: left;
    position: relative;
    z-index: 1;
  }

  /* Action buttons */
  .popup-buttons {
    display: flex;
    gap: 16px;
    justify-content: center;
  }

  .popup-skip,
  .popup-save {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 12px 24px;
    border-radius: 40px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 140px;
    justify-content: center;
  }

  .popup-skip {
    background: #ffffff;
    color: #000000;
    border: 2px solid #222;
  }

  .popup-skip:hover {
    background: #f8f8f8;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .popup-save {
    background: #222;
    color: #ffffff;
  }

  .popup-save:hover {
    background: #333;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
  }

  .popup-skip img,
  .popup-save img {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  /* Mobile adjustments for popup */
  @media (max-width: 600px) {
    .one-thing-popup-inner {
      padding: 8px 8px 32px 8px;
      width: 95%;
      max-width: 380px;
    }

    .popup-content-wrapper {
      padding: 16px;
      gap: 12px;
    }

    .popup-category-icon img {
      width: 400px;
      height: 200px;
      margin: -50px -100px;
      position: relative;
    }

    .one-thing-popup-inner h3 {
      font-size: 20px;
    }

    .one-thing-popup-inner p {
      font-size: 14px;
    }

    .popup-buttons {
      flex-direction: row;
      gap: 12px;
      width: 100%;
    }

    .popup-skip,
    .popup-save {
      flex: 1;
      padding: 16px 24px;
    }
  }

  /* Extra small screens for popup */
  @media (max-width: 400px) {
    .one-thing-popup-inner {
      width: 98%;
      padding: 4px 4px 24px 4px;
    }

    .popup-content-wrapper {
      padding: 12px;
      gap: 8px;
    }

    .popup-category-icon img {
      width: 300px;
      height: 150px;
      margin: -37.5px -75px;
      position: relative;
    }

    .one-thing-popup-inner h3 {
      font-size: 18px;
    }

    .one-thing-popup-inner p {
      font-size: 13px;
    }

    .popup-buttons {
      gap: 8px;
    }

    .popup-skip,
    .popup-save {
      padding: 12px 16px;
      font-size: 14px;
    }

    .referral-popup-inner,
    .confirmation-popup-inner {
      width: 98%;
      padding: 20px;
    }
  }

  /* Custom tooltip styles */
  .success-tooltip,
  .error-tooltip,
  .copy-error-tooltip,
  .heic-error-tooltip,
  .location-error-tooltip,
  .location-success-tooltip {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 16px;
    border-radius: 24px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 999999;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
    max-width: calc(100vw - 40px);
  }

  .success-tooltip {
    background: #B1E530;
    color: #000000;
    border: 1px solid rgba(0, 0, 0, 0.1);
    filter: drop-shadow(0 1px 3px rgba(121, 163, 5, 0.10)) drop-shadow(0 5px 5px rgba(121, 163, 5, 0.09)) drop-shadow(0 12px 7px rgba(121, 163, 5, 0.05)) drop-shadow(0 21px 9px rgba(121, 163, 5, 0.01)) drop-shadow(0 34px 9px rgba(121, 163, 5, 0.00));
  }

  .error-tooltip,
  .copy-error-tooltip,
  .heic-error-tooltip,
  .location-error-tooltip {
    background: #f44336;
    color: white;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
  }

  .location-success-tooltip {
    background: #B1E530;
    color: #000000;
    border: 1px solid rgba(0, 0, 0, 0.1);
    filter: drop-shadow(0 1px 3px rgba(121, 163, 5, 0.10)) drop-shadow(0 5px 5px rgba(121, 163, 5, 0.09)) drop-shadow(0 12px 7px rgba(121, 163, 5, 0.05)) drop-shadow(0 21px 9px rgba(121, 163, 5, 0.01)) drop-shadow(0 34px 9px rgba(121, 163, 5, 0.00));
  }

  .success-tooltip.show,
  .error-tooltip.show,
  .copy-error-tooltip.show,
  .heic-error-tooltip.show,
  .location-error-tooltip.show,
  .location-success-tooltip.show {
    opacity: 1;
    transform: translateX(0);
  }

  /* Removed styles for tooltip icons since we now only use text */

  /* Mobile adjustments for tooltip */
  @media (max-width: 600px) {
    .success-tooltip,
    .location-success-tooltip {
      top: 10px;
      right: 10px;
      left: 10px;
      transform: translateY(-100%);
      max-width: none;
    }

    .success-tooltip.show,
    .location-success-tooltip.show {
      transform: translateY(0);
    }
  }

  /* PROGRESS BAR COMPONENT CSS - START (can be easily removed) */
  /* Progress Bar Overlay */
  .progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.15);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .progress-overlay.show {
    opacity: 1;
    visibility: visible;
  }

  /* Progress Bar Styles */
  .progress-bar {
    position: fixed;
    top: 12px;
    left: 12px;
    right: 12px;
    background: #ffffff;
    border-radius: 24px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    padding: 12px 20px;
    z-index: 1001;
    transform: translateY(calc(-100% - 24px));
    transition: transform 0.3s ease;
    overflow: hidden;
  }


  .progress-bar.show {
    transform: translateY(0);
  }

  .progress-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .role-badge-container {
    display: flex;
    justify-content: center;
    margin-bottom: 8px;
  }

  .role-badge-container {
    position: relative;
    overflow: hidden;
    border-radius: 50%;
  }

  .role-badge-container img {
    width: 96px;
    height: 96px;
    transition: transform 0.1s ease-out;
    transform-style: preserve-3d;
    position: relative;
    z-index: 2;
  }

  .role-badge-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
    animation: badgeShimmer 3s ease-in-out infinite;
    z-index: 3;
    border-radius: 50%;
  }

  .role-badge-container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at center, rgba(177, 229, 48, 0.1) 0%, transparent 70%);
    animation: badgeGlow 4s ease-in-out infinite;
    z-index: 1;
    border-radius: 50%;
  }

  .role-achievement-label {
    font-family: 'Manrope', sans-serif;
    font-weight: 700;
    font-size: 24px;
    text-align: center;
    background: linear-gradient(45deg, #B1E530, #8BC34A, #4CAF50, #B1E530);
    background-size: 300% 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradientShift 3s ease-in-out infinite;
    text-shadow: 0 0 20px rgba(177, 229, 48, 0.3);
    padding: 8px 0;
    margin: 8px 0;
  }

  @keyframes gradientShift {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  @keyframes badgeShimmer {
    0% {
      left: -100%;
      opacity: 0;
    }
    10% {
      opacity: 1;
    }
    90% {
      opacity: 1;
    }
    100% {
      left: 100%;
      opacity: 0;
    }
  }

  @keyframes badgeGlow {
    0% {
      opacity: 0.3;
      transform: scale(1);
    }
    50% {
      opacity: 0.6;
      transform: scale(1.05);
    }
    100% {
      opacity: 0.3;
      transform: scale(1);
    }
  }



  .progress-counters {
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
  }

  .counter-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .counter-number {
    font-family: 'Manrope', sans-serif;
    font-weight: 700;
    font-size: 16px;
    color: #141414;
    line-height: 1;
  }

  .counter-label {
    font-family: 'Manrope', sans-serif;
    font-weight: 400;
    font-size: 16px;
    color: #666;
    line-height: 1;
  }


  .progress-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }

  .progress-bar-container {
    flex: 1;
    height: 8px;
    background: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #B1E530 0%, #8BC34A 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
    position: relative;
    min-width: 32px;
  }

  .user-avatar img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid #B1E530;
    object-fit: cover;
    object-position: center;
    display: block;
  }

  .progress-fill .user-avatar {
    position: absolute;
    right: -16px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .progress-fill .user-avatar img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid #B1E530;
    object-fit: cover;
    object-position: center;
    display: block;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .more-details-btn {
    font-family: 'Manrope', sans-serif;
    font-weight: 500;
    font-size: 14px;
    color: #666;
    background: transparent;
    border: 1px solid rgba(0, 0, 0, 0.1);
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .more-details-btn:hover {
    background: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.2);
    transform: translateY(-1px);
  }

  /* Levels Popup Styles */
  .levels-popup {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .levels-popup.show {
    opacity: 1;
    visibility: visible;
  }

  .levels-popup-inner {
    background: white;
    border-radius: 16px;
    padding: 24px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }

  .levels-popup.show .levels-popup-inner {
    transform: scale(1);
  }

  .levels-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .levels-header h3 {
    font-family: 'Manrope', sans-serif;
    font-weight: 700;
    font-size: 20px;
    color: #222;
    margin: 0;
  }

  .levels-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #666;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s ease;
  }

  .levels-close:hover {
    background: #f0f0f0;
  }

  .current-level-info {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: #f8f8f8;
    border-radius: 12px;
    margin-bottom: 20px;
  }

  .circular-progress-container {
    position: relative;
  }

  .circular-progress {
    position: relative;
    width: 80px;
    height: 80px;
  }

  .progress-ring {
    transform: rotate(-90deg);
    position: absolute;
    top: 0;
    left: 0;
  }

  .progress-ring-circle {
    transition: stroke-dashoffset 0.5s ease-in-out;
  }

  .current-level-avatar {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 48px;
    height: 48px;
    border-radius: 50%;
    overflow: hidden;
    z-index: 2;
  }

  .current-level-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
  }


  .current-level-details {
    flex: 1;
  }

  .current-level-name {
    font-family: 'Manrope', sans-serif;
    font-weight: 700;
    font-size: 18px;
    color: #222;
    margin-bottom: 4px;
  }

  .current-level-progress {
    font-family: 'Manrope', sans-serif;
    font-size: 14px;
    color: #666;
  }

  .levels-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .level-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 12px;
    border: 2px solid #e0e0e0;
    transition: all 0.2s ease;
  }

  .level-item.current {
    background: rgba(177, 229, 48, 0.1);
    border-color: #B1E530;
  }

  .level-item.completed {
    background: #f0f8f0;
    border-color: #4CAF50;
  }

  .level-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    color: white;
  }

  .level-details {
    flex: 1;
  }

  .level-name {
    font-family: 'Manrope', sans-serif;
    font-weight: 600;
    font-size: 16px;
    color: #222;
    margin-bottom: 2px;
  }

  .level-description {
    font-family: 'Manrope', sans-serif;
    font-size: 12px;
    color: #666;
    line-height: 1.4;
  }

  .level-xp {
    font-family: 'Manrope', sans-serif;
    font-weight: 600;
    font-size: 12px;
    color: #666;
  }

  /* Mobile adjustments for progress bar */
  @media (max-width: 600px) {
    .progress-bar {
      top: 8px;
      left: 8px;
      right: 8px;
      border-radius: 16px;
      padding: 8px 16px;
      transform: translateY(calc(-100% - 16px));
    }
    
    .progress-content {
      gap: 12px;
    }
    
    .role-badge-container img {
      width: 80px;
      height: 80px;
    }

    .role-achievement-label {
      font-size: 20px;
      padding: 6px 0;
      margin: 6px 0;
    }
    
    .progress-counters {
      gap: 16px;
    }
    
    .counter-number {
      font-size: 14px;
    }
    
    .counter-label {
      font-size: 14px;
    }
    
    .user-avatar img {
      width: 28px;
      height: 28px;
      object-fit: cover;
      object-position: center;
      display: block;
    }

    .progress-fill .user-avatar {
      right: -14px;
    }

    .progress-fill .user-avatar img {
      width: 28px;
      height: 28px;
    }
    
    .more-details-btn {
      font-size: 12px;
      padding: 6px 12px;
    }
    
    .levels-popup-inner {
      padding: 16px;
      width: 95%;
    }
  }
  /* PROGRESS BAR COMPONENT CSS - END */

  /* Footer styles */
  .footer {
    background-color: #F7F7F7;
    padding: 40px 20px;
    margin-top: 112px;
  }

  .footer-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .footer-left {
    display: flex;
    align-items: center;
  }

  .footer-logo {
    height: 20px;
    width: auto;
    opacity: 0.8;
    transition: opacity 0.2s ease;
  }

  .footer-logo:hover {
    opacity: 1;
  }

  .footer-right {
    display: flex;
    align-items: center;
    gap: 24px;
    flex-wrap: wrap;
  }

  .footer-link {
    color: #999999;
    text-decoration: underline;
    font-size: 14px;
    font-weight: 400;
    transition: color 0.2s ease;
  }

  .footer-link:hover {
    color: #666666;
  }

  /* Mobile footer adjustments */
  @media (max-width: 768px) {
    .footer {
      padding: 30px 20px;
      margin-top: 40px;
    }

    .footer-content {
      flex-direction: column;
      text-align: center;
      gap: 16px;
    }

    .footer-right {
      gap: 20px;
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    .footer {
      padding: 24px 16px;
      margin-top: 30px;
    }

    .footer-right {
      gap: 16px;
      flex-direction: column;
    }

    .footer-link {
      font-size: 13px;
    }
  }

  /* Location Modal styles */
  .location-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .location-modal.show {
    opacity: 1;
    visibility: visible;
  }

  .location-modal-content {
    background: white;
    border-radius: 24px;
    padding: 32px;
    max-width: 480px;
    width: 90%;
    height: 520px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    transform: translateY(20px);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
  }

  .location-modal.show .location-modal-content {
    transform: translateY(0);
  }

  .location-modal-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    position: relative;
  }

  .location-modal-title {
    font-size: 24px;
    font-weight: 600;
    color: #141414;
    margin: 0;
    text-align: center;
  }

  .location-modal-icon {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 16px 0 32px 0;
  }

  .location-modal-icon svg {
    width: 112px;
    height: 112px;
    opacity: 0.3;
    transition: opacity 0.3s ease;
  }

  .location-modal-icon.hidden {
    display: none;
  }

  .close-modal {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    cursor: pointer;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
    padding: 0;
  }

  .close-modal svg {
    width: 24px;
    height: 24px;
  }

  .close-modal:hover {
    background: #f0f0f0;
  }

  .location-input-section {
    margin-bottom: 24px;
  }





  .location-input {
    width: 100%;
    padding: 16px;
    border: 2px solid #E0E0E0;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 500;
    color: #141414;
    background: white;
    transition: all 0.2s ease;
    box-sizing: border-box;
    margin-bottom: 8px;
  }

  .location-input:focus {
    outline: none;
    border-color: #000000;
    box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
  }

  .location-input::placeholder {
    color: #999;
  }





  .location-results {
    margin-bottom: 24px;
    min-height: 0;
    max-height: 200px;
    overflow-y: auto;
    flex: 1;
  }

  .location-results:empty {
    display: none;
  }

  .location-result-item {
    padding: 16px;
    border: 1px solid #E0E0E0;
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: fadeInUp 0.3s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .location-result-item:hover {
    border-color: #B1E530;
    background: #F0F9F0;
  }

  .location-result-item:hover .location-icon img {
    filter: brightness(0) saturate(100%) invert(48%) sepia(79%) saturate(2476%) hue-rotate(86deg) brightness(118%) contrast(119%);
  }

  .location-result-item .location-name {
    font-size: 16px;
    font-weight: 600;
    color: #141414;
    margin-bottom: 4px;
  }

  .location-result-item .location-details {
    font-size: 14px;
    color: #666;
  }

  .location-result-item .location-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .location-result-item .location-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .location-result-item .location-content {
    flex: 1;
    text-align: left;
  }

  .location-result-item.loading {
    background: #f8f9fa;
    border-color: #e9ecef;
    cursor: default;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px 16px;
  }

  .location-result-item.loading .location-name {
    color: #6c757d;
  }

  .location-result-item.loading .location-icon img {
    filter: brightness(0) saturate(100%) invert(44%) sepia(8%) saturate(427%) hue-rotate(182deg) brightness(94%) contrast(86%);
  }

  .location-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #e9ecef;
    border-top: 2px solid #B1E530;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    flex-shrink: 0;
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.2);
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .location-result-item.error {
    background: #f8d7da;
    border-color: #f5c6cb;
    cursor: default;
  }

  .location-result-item.error .location-name {
    color: #721c24;
  }

  .location-result-item.error .location-details {
    color: #721c24;
  }

  .location-result-item.no-results {
    background: #f8f9fa;
    border-color: #e9ecef;
    cursor: default;
  }

  .location-result-item.no-results .location-name {
    color: #6c757d;
  }

  .location-result-item.no-results .location-details {
    color: #6c757d;
  }

  .location-result-item.no-results .location-icon img {
    filter: brightness(0) saturate(100%) invert(44%) sepia(8%) saturate(427%) hue-rotate(182deg) brightness(94%) contrast(86%);
  }

  .location-result-item.error .location-icon img {
    filter: brightness(0) saturate(100%) invert(15%) sepia(94%) saturate(7481%) hue-rotate(357deg) brightness(89%) contrast(101%);
  }

  .location-error-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .location-error-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .location-modal-buttons {
    display: flex;
    justify-content: center;
    margin-top: auto;
    padding-top: 24px;
  }

  .location-detect-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 16px 32px;
    background: #F0F0F0;
    border: none;
    border-radius: 16px;
    color: #141414;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 200px;
  }

  .location-detect-btn:hover {
    background: #E0E0E0;
  }

  .location-detect-btn svg {
    color: #666;
  }



  /* Mobile adjustments for location modal */
  @media (max-width: 768px) {
    .location-modal-content {
      padding: 24px;
      margin: 20px;
      width: calc(100% - 40px);
      height: 480px;
    }

    .location-modal-title {
      font-size: 20px;
    }

    .location-detect-btn {
      width: 100%;
      justify-content: center;
    }
  }

  /* Toggle switch styles */
  .toggle-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f8f8f8;
    border-radius: 20px;
    padding: 8px 12px;
    margin-top: 12px;
    border: 1px solid #e0e0e0;
  }

  .toggle-label {
    font-size: 13px;
    color: #666;
    font-weight: 500;
  }

  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #E0E0E0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 24px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .toggle-switch input:checked+.toggle-slider {
    background-color: #B1E530;
  }

  .toggle-switch input:checked+.toggle-slider:before {
    transform: translateX(20px);
  }

  /* Confirmation popup styles */
  .confirmation-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .confirmation-popup.show {
    opacity: 1;
    visibility: visible;
  }

  .confirmation-popup-inner {
    background: #ffffff;
    border-radius: 20px;
    padding: 32px;
    max-width: 400px;
    width: 95%;
    text-align: center;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    transform: scale(0.9) translateY(20px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .confirmation-popup.show .confirmation-popup-inner {
    transform: scale(1) translateY(0);
  }

  .confirmation-popup h3 {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 16px 0;
    color: #141414;
  }

  .confirmation-popup p {
    font-size: 14px;
    line-height: 1.5;
    color: #666;
    margin: 0 0 24px 0;
  }

  .confirmation-popup-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .confirmation-popup button {
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    min-width: 100px;
  }

  .confirmation-cancel {
    background: #f5f5f5;
    color: #666;
  }

  .confirmation-cancel:hover {
    background: #e0e0e0;
  }

  .confirmation-confirm {
    background: #B1E530;
    color: white;
  }

  .confirmation-confirm:hover {
    background: #B1E530;
  }
</style>

<div id="one-thing-account-component">
  <!-- User Profile Section -->
  <div class="user-profile-section">
    <!-- Map Background -->
    <div class="map-hero-wrapper">
      <div id="dynamic-map" class="map-background"></div>
      <div class="map-overlay-gradient"></div>
    </div>
    
    <!-- User Avatar -->
    <div class="user-avatar-container">
      <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6883c7a80506f986b2f7ddb7_db85210bbfb795678a1578319074aaf4_placeholder.svg" alt="User avatar" class="user-avatar" id="user-avatar">
    </div>
    
    <!-- Location Section - Top Left -->
    <div class="location-section">
      <div class="globio-nav-wrapper">
        <div class="globio-nav-inner">
          <p id="location-text">
            <span class="location-prefix">Feel at Home in</span>
            <span id="location-clickable">
              <span id="location-detect" class="location-name">your place</span>
              <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6826567e4c85159257ae5e4e_811a212cf32b6b680a0b472b1a82f601_edit%202-dark.svg"
                   alt="Edit icon" />
            </span>
          </p>
          <img id="mobile-pin" src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6889eb961e515115851948da_9c301540e2805651f3355e19910b6585_pin-2.svg" alt="Change location" />
        </div>
      </div>
    </div>
    
    <!-- User Menu Section - Top Right -->
    <div class="user-menu-section">
      <div class="user-menu-button" id="user-menu-button">
        <span class="user-level-badge" id="user-level-badge">Explorer</span>
        <div class="user-divider"></div>
        <span class="user-name" id="user-menu-name">User</span>
        <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      
      <!-- User Dropdown Menu -->
      <div class="user-dropdown" id="user-dropdown">
        <div class="user-dropdown-header">
          <div class="user-email" id="dropdown-user-email">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1.33594 4.66675L6.77922 8.47704C7.22 8.78559 7.44039 8.93986 7.68011 8.99962C7.89187 9.0524 8.11334 9.0524 8.32509 8.99962C8.56482 8.93986 8.78521 8.78559 9.22599 8.47704L14.6693 4.66675M4.53594 13.3334H11.4693C12.5894 13.3334 13.1494 13.3334 13.5773 13.1154C13.9536 12.9237 14.2595 12.6177 14.4513 12.2414C14.6693 11.8136 14.6693 11.2535 14.6693 10.1334V5.86675C14.6693 4.74664 14.6693 4.18659 14.4513 3.75877C14.2595 3.38244 13.9536 3.07648 13.5773 2.88474C13.1494 2.66675 12.5894 2.66675 11.4693 2.66675H4.53594C3.41583 2.66675 2.85578 2.66675 2.42796 2.88474C2.05163 3.07648 1.74567 3.38244 1.55392 3.75877C1.33594 4.18659 1.33594 4.74664 1.33594 5.86675V10.1334C1.33594 11.2535 1.33594 11.8136 1.55392 12.2414C1.74567 12.6177 2.05163 12.9237 2.42796 13.1154C2.85578 13.3334 3.41583 13.3334 4.53594 13.3334Z" stroke="#949494" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>user@example.com</span>
          </div>
        </div>
        <div class="user-dropdown-item" id="my-context-btn">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6.26466 12.914L6.65429 13.7903C6.77012 14.0511 6.95915 14.2728 7.19844 14.4283C7.43774 14.5839 7.71703 14.6666 8.00244 14.6666C8.28785 14.6666 8.56714 14.5839 8.80644 14.4283C9.04574 14.2728 9.23476 14.0511 9.35059 13.7903L9.74022 12.914C9.87892 12.6031 10.1122 12.3438 10.4069 12.1733C10.7034 12.0022 11.0464 11.9294 11.3869 11.9651L12.3402 12.0666C12.624 12.0966 12.9104 12.0436 13.1647 11.9141C13.419 11.7846 13.6302 11.5841 13.7728 11.337C13.9156 11.0899 13.9836 10.8068 13.9686 10.5218C13.9536 10.2369 13.8563 9.96245 13.6884 9.73177L13.1239 8.95622C12.9229 8.67801 12.8155 8.34313 12.8173 7.99992C12.8172 7.65764 12.9256 7.32415 13.1269 7.04733L13.6913 6.27177C13.8592 6.04109 13.9566 5.76663 13.9716 5.4817C13.9866 5.19677 13.9186 4.91361 13.7758 4.66659C13.6332 4.41941 13.4219 4.21891 13.1676 4.0894C12.9134 3.9599 12.627 3.90694 12.3432 3.93696L11.3898 4.03844C11.0494 4.07419 10.7064 4.00133 10.4098 3.83029C10.1146 3.65875 9.88123 3.39816 9.74318 3.08584L9.35059 2.20955C9.23476 1.9487 9.04574 1.72706 8.80644 1.57152C8.56714 1.41597 8.28785 1.33321 8.00244 1.33325C7.71703 1.33321 7.43774 1.41597 7.19844 1.57152C6.95915 1.72706 6.77012 1.9487 6.65429 2.20955L6.26466 3.08584C6.12662 3.39816 5.89325 3.65875 5.598 3.83029C5.30147 4.00133 4.95844 4.07419 4.618 4.03844L3.6617 3.93696C3.37792 3.90694 3.09153 3.9599 2.83724 4.0894C2.58296 4.21891 2.37171 4.41941 2.22911 4.66659C2.08632 4.91361 2.0183 5.19677 2.03329 5.4817C2.04828 5.76663 2.14564 6.04109 2.31355 6.27177L2.878 7.04733C3.07929 7.32415 3.18769 7.65764 3.18763 7.99992C3.18769 8.34219 3.07929 8.67569 2.878 8.95251L2.31355 9.72807C2.14564 9.95875 2.04828 10.2332 2.03329 10.5181C2.0183 10.8031 2.08632 11.0862 2.22911 11.3333C2.37185 11.5803 2.58313 11.7807 2.83737 11.9102C3.09162 12.0397 3.37794 12.0927 3.6617 12.0629L4.61503 11.9614C4.95548 11.9256 5.29851 11.9985 5.59503 12.1695C5.89139 12.3406 6.12584 12.6012 6.26466 12.914Z" stroke="#949494" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8.00125 9.99992C9.10582 9.99992 10.0013 9.10449 10.0013 7.99992C10.0013 6.89535 9.10582 5.99992 8.00125 5.99992C6.89668 5.99992 6.00125 6.89535 6.00125 7.99992C6.00125 9.10449 6.89668 9.99992 8.00125 9.99992Z" stroke="#949494" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          My Context
        </div>
        <div class="user-dropdown-item" id="logout-btn">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12.0026 5.33333L14.6693 8M14.6693 8L12.0026 10.6667M14.6693 8H6.0026M10.0026 2.80269C9.15277 2.29218 8.1661 2 7.11372 2C3.92274 2 1.33594 4.68629 1.33594 8C1.33594 11.3137 3.92274 14 7.11372 14C8.1661 14 9.15277 13.7078 10.0026 13.1973" stroke="#949494" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Logout
        </div>
      </div>
    </div>
  </div>

  <!-- My Context Modal -->
  <div class="my-context-modal" id="my-context-modal">
    <div class="my-context-content">
      <button class="close-modal" id="close-my-context-modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
        </svg>
      </button>
      <h2 class="my-context-title">
        My Context
      </h2>
      <p class="my-context-description">Here you can set your personal context—like whether you have kids, pets, or a car. This helps Globio suggest more relevant One Things for your life in a new city.</p>
      
      <!-- Switch Options -->
      <div class="switch-row">
        <div class="switch-card">
          <p class="switch-label">Kids</p>
          <label class="switch">
            <input type="checkbox" id="has-kids">
            <span class="slider round"></span>
          </label>
        </div>
        <div class="switch-card">
          <p class="switch-label">Pets</p>
          <label class="switch">
            <input type="checkbox" id="has-pets">
            <span class="slider round"></span>
          </label>
        </div>
        <div class="switch-card">
          <p class="switch-label">Car</p>
          <label class="switch">
            <input type="checkbox" id="has-car">
            <span class="slider round"></span>
          </label>
        </div>
      </div>
      
      <button class="save-changes-btn" id="save-context-btn">Save Changes</button>
    </div>
  </div>

  <!-- Location Change Modal -->
  <div class="location-modal" id="location-modal">
    <div class="location-modal-content">
      <div class="location-modal-header">
        <div class="location-modal-title">
          Change Location
        </div>
        <button class="close-modal" id="close-location-modal">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
      
      <div class="location-input-section">
        <input type="text" id="location-input" class="location-input" placeholder="e.g., London, Berlin, Tokyo">
      </div>

      <!-- Location Icon -->
      <div class="location-modal-icon">
        <svg width="112" height="112" viewBox="0 0 112 112" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12.5408 73.0105L21.4457 67.8698C21.928 67.5914 22.4941 67.4946 23.0415 67.5971L40.5625 70.8762C42.0024 71.1457 43.3316 70.0372 43.325 68.5723L43.2568 53.2207C43.255 52.8036 43.365 52.3936 43.5753 52.0335L52.4174 36.8956C52.8776 36.1077 52.8363 35.124 52.3118 34.3774L37.4242 13.1864M88.6703 22.6755C63.0036 35.0001 77.0028 51.3334 81.6703 53.6668C90.4299 58.0459 102.612 58.3332 102.612 58.3332C102.65 57.5602 102.669 56.7823 102.669 55.9999C102.669 30.2266 81.7759 9.33325 56.0026 9.33325C30.2293 9.33325 9.33594 30.2266 9.33594 55.9999C9.33594 81.7732 30.2293 102.667 56.0026 102.667C56.785 102.667 57.563 102.647 58.3359 102.609M78.2056 102.386L63.4273 63.4246L102.388 78.2029L85.1116 85.1089L78.2056 102.386Z" stroke="#E2E1E1" stroke-width="3.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="location-results" id="location-results"></div>
      
      <div class="location-modal-buttons">
        <button class="location-detect-btn" id="location-detect-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" fill="currentColor"/>
          </svg>
          Use Current Location
        </button>
      </div>
    </div>
  </div>

  <!-- Main button -->
  <div id="one-thing-btn" class="one-thing-account-btn">
    <div class="spinner-ring-account"></div>
    <lottie-player
      src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/66da138e010ced8db19ff94b_preloader-web.json"
      background="transparent" speed="1" style="width: 100px; height: 100px;" loop autoplay>
    </lottie-player>
  </div>
  <div id="attempts-counter"></div>
  <!-- Filters with icons -->
  <div class="filter-buttons">
    <div class="dropdown-container">
      <button class="dropdown-trigger active" id="all-categories-dropdown">
        <span>All Categories</span>
        <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
      </button>
      <div class="dropdown-menu" id="categories-dropdown-menu">
        <div class="dropdown-item" data-category="all">
          <div class="category-indicator all"></div>
          <span>All Categories</span>
        </div>
        <div class="dropdown-item" data-category="daily">
          <div class="category-indicator daily"></div>
          <span>Daily Things</span>
        </div>
        <div class="dropdown-item" data-category="places">
          <div class="category-indicator places"></div>
          <span>Places</span>
        </div>
        <div class="dropdown-item" data-category="local">
          <div class="category-indicator local"></div>
          <span>Local Context</span>
        </div>
      </div>
    </div>
    <div class="filter-group">
      <button data-filter="saved">
        <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/689626252407e18c78a483d3_saved-icon.svg"
          alt="Saved" width="16" height="16">
        <span>Saved</span>
      </button>
      <button data-filter="completed">
        <img
          src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68962640c9b2c3eb35cd53d1_completed-icon.svg"
          alt="Completed" width="16" height="16">
        <span>Completed</span>
      </button>
      <div class="filter-divider"></div>
      <button data-filter="community">
        <img
          src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68962655c9b2c3eb35cd5a48_community-icon.svg"
          alt="Community" width="16" height="16">
        <span>Community</span>
      </button>
    </div>
  </div>
  <div id="one-thing-card-list"></div>
</div>

<!-- PROGRESS BAR COMPONENT - START (can be easily removed) -->

<!-- Progress Bar Overlay -->
<div id="progress-overlay" class="progress-overlay"></div>

<!-- Progress Bar (appears on scroll) -->
<div id="progress-bar" class="progress-bar">
  <div class="progress-content">
        <div class="role-badge-container">
          <img id="role-badge" src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68b4962706ed934b893dd109_adaptio.svg" alt="Role Badge" width="32" height="32">
        </div>
        <div class="role-achievement-label" id="role-achievement-label">Explorer</div>
    <div class="progress-counters">
      <div class="counter-item">
        <span class="counter-number" id="saved-counter">0</span>
        <span class="counter-label">Things saved</span>
      </div>
      <div class="counter-item">
        <span class="counter-number" id="completed-counter">0</span>
        <span class="counter-label">Things completed</span>
      </div>
      <div class="counter-item">
        <span class="counter-number" id="published-counter">0</span>
        <span class="counter-label">Thing published</span>
      </div>
    </div>
    <div class="progress-info">
      <div class="progress-bar-container">
        <div class="progress-fill" id="progress-fill">
          <div class="user-avatar">
            <img id="progress-avatar" src="" alt="User Avatar" width="32" height="32">
          </div>
        </div>
      </div>
      <button class="more-details-btn" id="more-details-btn">More Details</button>
    </div>
  </div>
</div>
<!-- PROGRESS BAR COMPONENT - END -->

<!-- Success tooltip -->
<div id="success-tooltip" class="success-tooltip">
  <span>Thing completed!</span>
</div>

<!-- Public success tooltip -->
<div id="public-success-tooltip" class="success-tooltip">
  <span>Thing is Public!</span>
</div>

<!-- Private success tooltip -->
<div id="private-success-tooltip" class="success-tooltip">
  <span>Thing is Private!</span>
</div>

<!-- Saved success tooltip -->
<div id="saved-success-tooltip" class="success-tooltip">
  <span>Thing Saved!</span>
</div>

<!-- Copy Error tooltip -->
<div id="copy-error-tooltip" class="copy-error-tooltip">
  <span>Failed to copy link. Please copy manually.</span>
</div>

<!-- HEIC Error tooltip -->
<div id="heic-error-tooltip" class="heic-error-tooltip">
  <span>Error converting HEIC image. Please try a different image format.</span>
</div>

<!-- Location Error tooltip -->
<div id="location-error-tooltip" class="location-error-tooltip">
  <span>Location error occurred</span>
</div>

<!-- Location Success tooltip -->
<div id="location-success-tooltip" class="location-success-tooltip">
  <span>Location changed successfully!</span>
</div>

<!-- Context Updated tooltip -->
<div id="context-success-tooltip" class="success-tooltip">
  <span>Context Updated!</span>
</div>

<!-- Levels popup -->
<div id="levels-popup" class="levels-popup">
  <div class="levels-popup-inner">
    <div class="levels-header">
      <h3>Your Progress</h3>
      <button class="levels-close" id="levels-close">×</button>
    </div>
    <div class="levels-content">
      <div class="current-level-info">
        <div class="circular-progress-container">
          <div class="circular-progress">
            <svg class="progress-ring" width="80" height="80">
              <circle class="progress-ring-circle-bg" cx="40" cy="40" r="35" fill="transparent" stroke="#e0e0e0" stroke-width="6"/>
              <circle class="progress-ring-circle" cx="40" cy="40" r="35" fill="transparent" stroke="#B1E530" stroke-width="6" stroke-linecap="round" stroke-dasharray="219.8" stroke-dashoffset="219.8"/>
            </svg>
            <div class="current-level-avatar">
              <img id="levels-avatar" src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6883c7a80506f986b2f7ddb7_db85210bbfb795678a1578319074aaf4_placeholder.svg" alt="User Avatar" width="48" height="48">
            </div>
          </div>
        </div>
        <div class="current-level-details">
          <div class="current-level-name" id="current-level-name">Explorer</div>
          <div class="current-level-progress" id="current-level-progress">0 / 100 XP</div>
        </div>
      </div>
      <div class="levels-list" id="levels-list">
        <!-- Levels will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Confirmation popup -->
<div id="confirmation-popup" class="confirmation-popup">
  <div class="confirmation-popup-inner">
    <h3 id="confirmation-title">Make Thing Public?</h3>
    <p id="confirmation-description">This will make your completed thing visible to the community. Other users will be
      able to see and get inspired by your experience.</p>
    <div class="confirmation-popup-buttons">
      <button class="confirmation-cancel" id="confirmation-cancel">Cancel</button>
      <button class="confirmation-confirm" id="confirmation-confirm">Make Thing Public</button>
    </div>
  </div>
</div>

<!-- Referral Popup -->
<div id="referral-popup" class="referral-popup">
  <div class="referral-popup-inner">
    <h3>Invite Friends</h3>
    <p>Share your personal referral link with friends and help them discover amazing things in your area!</p>
    <div class="referral-link-container">
      <span class="referral-link" id="referral-link-text">
        <span class="base-url">https://globio.io/ref/</span><span class="highlight" id="referral-code">YOURCODE</span>
      </span>
      <button class="copy-btn" id="copy-referral-btn">Copy</button>
    </div>
    <div class="referral-popup-buttons">
      <button class="btn-secondary" id="referral-close">Close</button>
    </div>
  </div>
</div>

<!-- Community Empty State Popup -->
<div id="community-empty-popup" class="referral-popup">
  <div class="referral-popup-inner">
    <h3>Expand Globio Community</h3>
    <p>Here's your referral code. Copy it and share with friends to expand the Globio community in your area!</p>
    <div class="referral-link-container">
      <span class="referral-link" id="community-referral-link-text">
        <span class="base-url">https://globio.io/ref/</span><span class="highlight"
          id="community-referral-code">YOURCODE</span>
      </span>
      <button class="copy-btn" id="copy-community-referral-btn">Copy</button>
    </div>
    <div class="referral-popup-buttons">
      <button class="btn-secondary" id="community-popup-close">Close</button>
    </div>
  </div>
</div>

<!-- Card popup -->
<div id="one-thing-popup" class="one-thing-popup">
  <div class="one-thing-popup-inner">
    <!-- Content wrapper with pill, icon, title, and description -->
    <div class="popup-content-wrapper">
      <!-- Category pill -->
      <div class="popup-category-pill" id="popup-category">
        <span id="popup-category-text">Places</span>
      </div>

      <!-- Category icon -->
      <div class="popup-category-icon" id="popup-category-icon">
        <img id="popup-category-image" src="" alt="Category icon">
      </div>

      <!-- Title and description -->
      <h3 id="popup-title"></h3>
      <p id="popup-desc"></p>
    </div>

    <!-- Action buttons -->
    <div class="popup-buttons">
      <button id="popup-skip" class="popup-skip">
        <img
          src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6820b6797ea854969e2c43ab_skip-card-icon.svg"
          alt="Skip" width="16" height="16">
        <span>Skip</span>
      </button>
      <button id="popup-save" class="popup-save">
        <img
          src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6820b67bc960fe7e64297756_save-card-icon.svg"
          alt="Save" width="16" height="16">
        <span>Save</span>
      </button>
    </div>
  </div>
</div>

<script>
  (function () {
  // Mapbox configuration
  const mapboxToken = "pk.eyJ1IjoibWF4aW1nbG9iaW8iLCJhIjoiY205ZTV1Z3Q0MTJuZjJrczduaWpmczFxOSJ9.uxg6_dvAoTHfmhAicl9pjA";

  // Initialize map
  function initializeMap(lat, lon) {
    if (typeof mapboxgl === 'undefined') {
      console.log('Mapbox not loaded yet, retrying...');
      setTimeout(() => initializeMap(lat, lon), 1000);
      return;
    }

    mapboxgl.accessToken = mapboxToken;
    const map = new mapboxgl.Map({
      container: 'dynamic-map',
      style: 'mapbox://styles/mapbox/light-v10',
      center: [lon, lat],
      zoom: 5.5,
      projection: 'globe',
      interactive: false
    });

    map.on('style.load', () => {
      map.setFog({
        color: 'white',
        'high-color': '#add8e6',
        'horizon-blend': 0.2,
        'space-color': '#dfefff',
        'star-intensity': 0.0
      });
    });
  }

  // Geocode location
  function geocodeLocation(query, callback) {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          callback(lat, lon);
        } else {
          fallbackLocation(callback);
        }
      })
      .catch(() => fallbackLocation(callback));
  }

  // Fallback location
  function fallbackLocation(callback) {
    fetch('https://ipapi.co/json/')
      .then(res => res.json())
      .then(data => {
        const lat = data.latitude;
        const lon = data.longitude;
        window.userLocation = `${data.city}, ${data.country_name}`;
        callback(lat, lon);
      })
      .catch(() => {
        window.userLocation = 'Alanya, Turkey';
        callback(36.5438, 32.0060);
      });
  }

  // Load map
  function loadMap() {
    const manualLocation = localStorage.getItem("userLocation");
    if (manualLocation) {
      geocodeLocation(manualLocation, initializeMap);
    } else {
      fallbackLocation(initializeMap);
    }
  }

  // Function to load user data from Xano
  function loadUserDataFromXano(userId) {
    console.log('🔍 Loading user data for userId:', userId);
    console.log('🔍 API URL:', `https://xu8w-at8q-hywg.n7d.xano.io/api:WT6s5fz4/one_thing_users/${userId}`);
    fetch(`https://xu8w-at8q-hywg.n7d.xano.io/api:WT6s5fz4/one_thing_users/${userId}`)
      .then(response => {
        console.log('🔍 User data response status:', response.status);
        console.log('🔍 Response headers:', response.headers);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('🔍 User data loaded:', data);
        console.log('🔍 User picture field:', data.picture);
        console.log('🔍 User name field:', data.name);
        
        // Update user avatar (for map avatar, progress bar, and levels popup)
        if (data.picture) {
          console.log('🔍 Updating user avatar to:', data.picture);
          const userAvatar = document.getElementById('user-avatar');
          const progressAvatar = document.getElementById('progress-avatar');
          const levelsAvatar = document.getElementById('levels-avatar');
          
          console.log('🔍 user-avatar element found:', !!userAvatar);
          console.log('🔍 progress-avatar element found:', !!progressAvatar);
          console.log('🔍 levels-avatar element found:', !!levelsAvatar);
          
          // Construct full URL for avatar
          const avatarUrl = data.picture.startsWith('http') ? data.picture : `https://xu8w-at8q-hywg.n7d.xano.io${data.picture}`;
          console.log('🔍 Full avatar URL:', avatarUrl);
          
          // Update map avatar
          if (userAvatar) {
            console.log('🔍 Setting user-avatar src to:', avatarUrl);
            userAvatar.src = avatarUrl;
            userAvatar.onerror = function() {
              console.log('⚠️ Failed to load user avatar, using placeholder');
              this.src = 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6883c7a80506f986b2f7ddb7_db85210bbfb795678a1578319074aaf4_placeholder.svg';
            };
            userAvatar.onload = function() {
              console.log('✅ User avatar loaded successfully');
            };
          } else {
            console.log('❌ user-avatar element not found in DOM');
          }
          
          // Update progress bar avatar
          if (progressAvatar) {
            console.log('🔍 Setting progress-avatar src to:', avatarUrl);
            progressAvatar.src = avatarUrl;
            progressAvatar.onerror = function() {
              console.log('⚠️ Failed to load progress avatar, using placeholder');
              this.src = 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6883c7a80506f986b2f7ddb7_db85210bbfb795678a1578319074aaf4_placeholder.svg';
            };
            progressAvatar.onload = function() {
              console.log('✅ Progress avatar loaded successfully');
            };
          } else {
            console.log('❌ progress-avatar element not found in DOM');
          }
          
          // Update levels popup avatar
          if (levelsAvatar) {
            console.log('🔍 Setting levels-avatar src to:', avatarUrl);
            levelsAvatar.src = avatarUrl;
            levelsAvatar.onerror = function() {
              console.log('⚠️ Failed to load levels avatar, using placeholder');
              this.src = 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6883c7a80506f986b2f7ddb7_db85210bbfb795678a1578319074aaf4_placeholder.svg';
            };
            levelsAvatar.onload = function() {
              console.log('✅ Levels avatar loaded successfully');
            };
          } else {
            console.log('❌ levels-avatar element not found in DOM');
          }
        } else {
          console.log('⚠️ No user picture found in data');
        }
        
        // Update user name
        if (data.name) {
          console.log('🔍 Updating user name to:', data.name);
          const userMenuName = document.getElementById('user-menu-name');
          const dropdownUserName = document.getElementById('dropdown-user-name');
          
          console.log('🔍 user-menu-name element found:', !!userMenuName);
          console.log('🔍 dropdown-user-name element found:', !!dropdownUserName);
          
          if (userMenuName) {
            userMenuName.textContent = data.name;
            console.log('✅ User menu name updated successfully');
          } else {
            console.log('❌ user-menu-name element not found');
          }
          
          if (dropdownUserName) {
            dropdownUserName.textContent = data.name;
            console.log('✅ Dropdown user name updated successfully');
          } else {
            console.log('❌ dropdown-user-name element not found');
          }
        } else {
          console.log('⚠️ No user name found in data');
        }
        
        // Update user email
        console.log('🔍 Checking email field in data:', data.email);
        if (data.email) {
          console.log('🔍 Updating user email to:', data.email);
          
          // Try multiple selectors
          const emailElement1 = document.querySelector('#dropdown-user-email span');
          const emailElement2 = document.querySelector('.user-email span');
          const emailElement3 = document.getElementById('dropdown-user-email');
          
          console.log('🔍 Selector 1 (#dropdown-user-email span):', emailElement1);
          console.log('🔍 Selector 2 (.user-email span):', emailElement2);
          console.log('🔍 Selector 3 (#dropdown-user-email):', emailElement3);
          
          let targetElement = emailElement1 || emailElement2;
          
          if (targetElement) {
            console.log('🔍 Found email element, updating text content');
            targetElement.textContent = data.email;
            console.log('✅ User email updated successfully to:', data.email);
          } else           if (emailElement3) {
            console.log('🔍 Found parent element, updating innerHTML');
            emailElement3.innerHTML = `
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M2 4L8 9L14 4M2 4C2 3.44772 2.44772 3 3 3H13C13.5523 3 14 3.44772 14 4V12C14 12.5523 13.5523 13 13 13H3C2.44772 13 2 12.5523 2 12V4Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>${data.email}</span>
            `;
            console.log('✅ User email updated via innerHTML to:', data.email);
            
            // Force update with delay to ensure DOM is ready
            setTimeout(() => {
              const finalCheck = document.getElementById('dropdown-user-email');
              if (finalCheck) {
                console.log('🔍 Final check - email element text:', finalCheck.textContent);
                console.log('🔍 Final check - email element innerHTML:', finalCheck.innerHTML);
              }
            }, 100);
          } else {
            console.log('❌ No email element found with any selector');
            console.log('🔍 All elements with user-email class:', document.querySelectorAll('.user-email'));
            console.log('🔍 All elements with dropdown-user-email id:', document.querySelectorAll('#dropdown-user-email'));
          }
        } else {
          console.log('⚠️ No user email found in data');
          console.log('🔍 Available fields in data:', Object.keys(data));
        }
      })
      .catch(error => {
        console.error('❌ Error loading user data:', error);
        console.error('❌ This might be why avatars are not loading');
      });
  }

  // User profile functionality
  function initializeUserProfile() {
    try {
      console.log('🔍 initializeUserProfile called');
      // Load user data from Xano
      console.log('🔍 All localStorage keys:', Object.keys(localStorage));
      console.log('🔍 All localStorage data:', localStorage);
      const authRaw = localStorage.getItem('auth');
      console.log('🔍 Auth data from localStorage:', authRaw);
      
      // Try other possible keys
      const authRaw2 = localStorage.getItem('user');
      console.log('🔍 User data from localStorage:', authRaw2);
      const authRaw3 = localStorage.getItem('userData');
      console.log('🔍 UserData from localStorage:', authRaw3);
      const authRaw4 = localStorage.getItem('xano_auth');
      console.log('🔍 Xano auth from localStorage:', authRaw4);
      const userId = localStorage.getItem('userId');
      console.log('🔍 UserId from localStorage:', userId);
      
      // Use userId directly if available
      if (userId) {
        console.log('🔍 Using userId directly:', userId);
        loadUserDataFromXano(userId);
      } else if (authRaw) {
        try {
          const auth = JSON.parse(authRaw);
          const userId = auth.id;
          console.log('🔍 Parsed auth data:', auth);
          console.log('🔍 User ID from auth:', userId);
          if (userId) {
            loadUserDataFromXano(userId);
          }
        } catch (e) {
          console.error('Error parsing auth from localStorage:', e);
        }
      }
    } catch (error) {
      console.error('❌ Error in initializeUserProfile:', error);
    }
  }

  // Location functionality
  function initializeLocation() {
    
    function updateLocationUI(value) {
      const locationText = value || "your place";
      window.userLocation = locationText;
      
      // Update the entire location-text structure to maintain proper styling
      const locationTextContainer = document.getElementById('location-text');
      if (locationTextContainer) {
        locationTextContainer.innerHTML = `
          <span class="location-prefix">Feel at Home in</span>
          <span id="location-clickable">
            <span id="location-detect" class="location-name">${locationText}</span>
            <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6826567e4c85159257ae5e4e_811a212cf32b6b680a0b472b1a82f601_edit%202-dark.svg" alt="Edit icon" />
          </span>
        `;
        
        // Re-attach event listener to the new location-clickable element
        const newLocationClickable = locationTextContainer.querySelector('#location-clickable');
        if (newLocationClickable) {
          newLocationClickable.addEventListener('click', showLocationPrompt);
        }
      }
    }
    
    function showLocationPrompt() {
      // Open our custom location modal instead of system prompt
      const locationModal = document.getElementById('location-modal');
      if (locationModal) {
        locationModal.classList.add('show');
        // Focus on input field
        const locationInput = document.getElementById('location-input');
        if (locationInput) {
          locationInput.focus();
        }
      }
    }
    
    // Event listeners
    document.getElementById('location-clickable').addEventListener('click', showLocationPrompt);
    document.getElementById('mobile-pin').addEventListener('click', showLocationPrompt);
    

    
    // Load saved location or detect automatically
    const savedLocation = localStorage.getItem("userLocation");
    if (savedLocation) {
      updateLocationUI(savedLocation);
    } else {
      fetch('https://ipapi.co/json/')
        .then(res => res.json())
        .then(data => {
          const auto = data.city && data.country_name
            ? `${data.city}, ${data.country_name}`
            : data.city || data.country_name || "your place";
          localStorage.setItem("userLocation", auto);
          updateLocationUI(auto);
        })
        .catch(() => {
          updateLocationUI("your place");
        });
    }
  }

  // User dropdown functionality
  function initializeUserDropdown() {
    const userMenuButton = document.getElementById('user-menu-button');
    const userDropdown = document.getElementById('user-dropdown');
    
    // Toggle dropdown
    userMenuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      userDropdown.classList.toggle('show');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!userMenuButton.contains(e.target) && !userDropdown.contains(e.target)) {
        userDropdown.classList.remove('show');
      }
    });
    
    // Close dropdown on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        userDropdown.classList.remove('show');
      }
    });
  }

  // My Context modal functionality
  function initializeMyContextModal() {
    const myContextBtn = document.getElementById('my-context-btn');
    const myContextModal = document.getElementById('my-context-modal');
    const closeModalBtn = document.getElementById('close-my-context-modal');
    const saveBtn = document.getElementById('save-context-btn');
    const userDropdown = document.getElementById('user-dropdown');
    
    // Load saved context
    const hasKids = localStorage.getItem('hasKids') === 'true';
    const hasPets = localStorage.getItem('hasPets') === 'true';
    const hasCar = localStorage.getItem('hasCar') === 'true';
    
    console.log('Loading saved context:', { hasKids, hasPets, hasCar }); // Debug log
    
    document.getElementById('has-kids').checked = hasKids;
    document.getElementById('has-pets').checked = hasPets;
    document.getElementById('has-car').checked = hasCar;
    
    console.log('Context loaded and checkboxes updated'); // Debug log
    
    // Open modal
    myContextBtn.addEventListener('click', () => {
      console.log('My Context button clicked'); // Debug log
      userDropdown.classList.remove('show');
      myContextModal.classList.add('show');
      console.log('My Context modal opened'); // Debug log
    });
    
    // Close modal
    closeModalBtn.addEventListener('click', () => {
      console.log('My Context modal close button clicked'); // Debug log
      myContextModal.classList.remove('show');
      console.log('My Context modal closed'); // Debug log
    });
    
    // Close modal when clicking outside
    myContextModal.addEventListener('click', (e) => {
      if (e.target === myContextModal) {
        myContextModal.classList.remove('show');
      }
    });
    
    // Save context
    saveBtn.addEventListener('click', () => {
      console.log('Save context button clicked'); // Debug log
      const hasKids = document.getElementById('has-kids').checked;
      const hasPets = document.getElementById('has-pets').checked;
      const hasCar = document.getElementById('has-car').checked;
      
      console.log('Context values:', { hasKids, hasPets, hasCar }); // Debug log
      
      localStorage.setItem('hasKids', hasKids);
      localStorage.setItem('hasPets', hasPets);
      localStorage.setItem('hasCar', hasCar);
      
      console.log('Context saved to localStorage'); // Debug log
      
      myContextModal.classList.remove('show');
      
      // Show success message
      showContextSuccessTooltip();
    });
  }

  // Helper function to update location UI from modal
  function updateLocationUIFromModal(locationName) {
    console.log('Updating location UI with:', locationName); // Debug log
    window.userLocation = locationName;
    
    // Update the entire location-text structure to maintain proper styling
    const locationTextContainer = document.getElementById('location-text');
    console.log('Location text container found:', !!locationTextContainer); // Debug log
    if (locationTextContainer) {
      locationTextContainer.innerHTML = `
        <span class="location-prefix">Feel at Home in</span>
        <span id="location-clickable">
          <span id="location-detect" class="location-name">${locationName}</span>
          <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6826567e4c85159257ae5e4e_811a212cf32b6b680a0b472b1a82f601_edit%202-dark.svg" alt="Edit icon" />
        </span>
      `;
      
      // Re-attach event listener to the new location-clickable element
      const newLocationClickable = locationTextContainer.querySelector('#location-clickable');
      console.log('New location clickable found:', !!newLocationClickable); // Debug log
      if (newLocationClickable) {
        newLocationClickable.addEventListener('click', () => {
          console.log('New location clickable clicked'); // Debug log
          const locationModal = document.getElementById('location-modal');
          if (locationModal) {
            locationModal.classList.add('show');
            const locationInput = document.getElementById('location-input');
            if (locationInput) {
              locationInput.focus();
            }
          }
        });
        console.log('Event listener attached to new location clickable'); // Debug log
      }
    }
    console.log('Location UI update completed'); // Debug log
  }

  // Location Modal functionality
  function initializeLocationModal() {
    const locationModal = document.getElementById('location-modal');
    const closeLocationModal = document.getElementById('close-location-modal');
    const locationInput = document.getElementById('location-input');
    const locationIcon = document.querySelector('.location-modal-icon');

    const locationDetectBtn = document.getElementById('location-detect-btn');
    const locationResults = document.getElementById('location-results');

    // Handle input changes to show/hide location icon
    if (locationInput && locationIcon) {
      locationInput.addEventListener('input', () => {
        if (locationInput.value.trim().length > 0) {
          locationIcon.classList.add('hidden');
        } else {
          locationIcon.classList.remove('hidden');
        }
      });
    }

    // Open location modal when clicking on location section
    const locationClickable = document.getElementById('location-clickable');
    if (locationClickable) {
      locationClickable.addEventListener('click', () => {
        locationModal.classList.add('show');
        locationInput.focus();
      });
    }

    // Close modal functions
    function closeModal() {
      console.log('Closing modal...'); // Debug log
      locationModal.classList.remove('show');
      locationInput.value = '';
      locationResults.innerHTML = '';
      // Show location icon again when modal is closed
      if (locationIcon) {
        locationIcon.classList.remove('hidden');
      }
      console.log('Modal closed'); // Debug log
    }

    closeLocationModal.addEventListener('click', closeModal);

    // Close modal when clicking outside
    locationModal.addEventListener('click', (e) => {
      if (e.target === locationModal) {
        closeModal();
      }
    });

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && locationModal.classList.contains('show')) {
        closeModal();
      }
    });

    // Search location functionality
    async function searchLocation(query) {
      if (!query.trim()) return;

      // Show loading state with spinner only
      locationResults.innerHTML = '<div class="location-result-item loading"><div class="location-spinner"></div></div>';

      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
        const data = await response.json();
        
        displayLocationResults(data);
      } catch (error) {
        console.error('Error searching location:', error);
        locationResults.innerHTML = '<div class="location-result-item error"><div class="location-error-icon"><img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6889eb961e515115851948da_9c301540e2805651f3355e19910b6585_pin-2.svg" alt="Error" width="20" height="20"></div><div class="location-content"><div class="location-name">Search error</div><div class="location-details">Please try again</div></div></div>';
      }
    }

    // Display search results
    function displayLocationResults(results) {
      if (results.length === 0) {
        locationResults.innerHTML = '<div class="location-result-item no-results"><div class="location-icon"><img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6889eb961e515115851948da_9c301540e2805651f3355e19910b6585_pin-2.svg" alt="Location" width="20" height="20"></div><div class="location-content"><div class="location-name">No locations found</div><div class="location-details">Try a different search term</div></div></div>';
        return;
      }

      locationResults.innerHTML = results.map(result => {
        const displayName = result.display_name.split(', ').slice(0, 2).join(', ');
        return `
          <div class="location-result-item" data-lat="${result.lat}" data-lon="${result.lon}" data-display-name="${result.display_name}">
            <div class="location-icon"><img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6889eb961e515115851948da_9c301540e2805651f3355e19910b6585_pin-2.svg" alt="Location" width="20" height="20"></div>
            <div class="location-content">
              <div class="location-name">${displayName}</div>
              <div class="location-details">${result.display_name}</div>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers to results (use event delegation to avoid multiple handlers)
      if (!locationResults.hasAttribute('data-handler-attached')) {
        locationResults.setAttribute('data-handler-attached', 'true');
        locationResults.addEventListener('click', (e) => {
          const item = e.target.closest('.location-result-item');
          if (!item) return;
          
          console.log('Location item clicked:', item.dataset); // Debug log
          const lat = item.dataset.lat;
          const lon = item.dataset.lon;
          let displayName = item.dataset.displayName;
          
          // Limit to city and country only
          const parts = displayName.split(', ');
          if (parts.length > 2) {
            // Take city and country, skip detailed address
            const city = parts[0];
            const country = parts[parts.length - 1];
            displayName = `${city}, ${country}`;
          }
          
          // Update user location
          localStorage.setItem('userLocation', displayName);
          
          // Close modal immediately
          closeModal();
          
          // Show location success message
          showLocationSuccessTooltip();
          
          // Reload page to update the map with new location
          setTimeout(() => {
            location.reload();
          }, 1000);
        });
      }
    }

    // Show autosuggest based on input
    locationInput.addEventListener('input', () => {
      const query = locationInput.value.trim();
      
      if (query) {
        // Show autosuggest after 300ms delay to avoid too many API calls
        clearTimeout(window.autosuggestTimeout);
        window.autosuggestTimeout = setTimeout(() => {
          if (query.length >= 2) { // Only search if 2+ characters
            searchLocation(query);
          }
        }, 300);
      } else {
        // Clear results when input is empty
        locationResults.innerHTML = '';
      }
    });

    // Search on Enter key
    locationInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = locationInput.value.trim();
        if (query) {
          searchLocation(query);
        }
      }
    });

    // Search on blur (when input loses focus)
    locationInput.addEventListener('blur', () => {
      const query = locationInput.value.trim();
      if (query && query.length >= 2) {
        searchLocation(query);
      }
    });

    // Use current location
    locationDetectBtn.addEventListener('click', async () => {
      if (navigator.geolocation) {
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });
          
          const { latitude, longitude } = position.coords;
          
          // Reverse geocode to get location name
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10`);
          const data = await response.json();
          
          if (data.display_name) {
            // Limit to city and country only
            let locationName = data.display_name;
            const parts = locationName.split(', ');
            if (parts.length > 2) {
              // Take city and country, skip detailed address
              const city = parts[0];
              const country = parts[parts.length - 1];
              locationName = `${city}, ${country}`;
            }
            
            localStorage.setItem('userLocation', locationName);
            
            // Close modal immediately
            closeModal();
            showLocationSuccessTooltip();
            
            // Reload page to update the map with new location
            setTimeout(() => {
              location.reload();
            }, 1000);
          }
        } catch (error) {
          console.error('Error getting current location:', error);
          showLocationErrorTooltip('Could not get your current location. Please try searching manually.');
        }
      } else {
        showLocationErrorTooltip('Geolocation is not supported by this browser.');
      }
    });
  }

  // Logout functionality
  function initializeLogout() {
    const logoutBtn = document.getElementById('logout-btn');
    
    if (logoutBtn) {
      logoutBtn.addEventListener('click', (event) => {
        event.preventDefault();
        performLogout();
      });
    }
  }

  // Comprehensive logout function
  function performLogout() {
    console.log('🔍 Logout initiated');
    
    // Close dropdown if open
    const userDropdown = document.querySelector('.user-dropdown');
    if (userDropdown) {
      userDropdown.classList.remove('show');
    }
    
    // Clear all authentication data
    localStorage.removeItem('auth');
    localStorage.removeItem('userId');
    localStorage.removeItem('userData');
    localStorage.removeItem('xano_auth');
    localStorage.removeItem('reloadAccountOnce');
    localStorage.removeItem('justReloaded');
    
    // Clear user-specific data (optional - depends on your needs)
    // localStorage.removeItem('savedCards');
    // localStorage.removeItem('completedCards');
    // localStorage.removeItem('publicCards');
    
    console.log('✅ All auth data cleared');
    
    // Redirect to login page or home
    window.location.href = 'https://globio.io/one-thing';
  }

  // Initialize everything when DOM is ready
  function initializeEverything() {
    console.log('🔍 initializeEverything called');
    loadMap();
    console.log('🔍 About to call initializeUserProfile');
    initializeUserProfile();
    console.log('🔍 initializeUserProfile completed');
    initializeLocation();
    initializeUserDropdown();
    initializeMyContextModal();
    initializeLocationModal();
    initializeLogout();
  }

  // Initialize when DOM is ready
  console.log('🔍 Document ready state:', document.readyState);
  if (document.readyState === 'loading') {
    console.log('🔍 DOM is still loading, adding event listener');
    document.addEventListener('DOMContentLoaded', initializeEverything);
  } else {
    console.log('🔍 DOM is ready, calling initializeEverything immediately');
    initializeEverything();
  }

  // Global context getter for One Thing generation
  window.getUserContext = () => {
    return {
      location: window.userLocation || 'your place',
      hasKids: localStorage.getItem('hasKids') === 'true',
      hasPets: localStorage.getItem('hasPets') === 'true',
      hasCar: localStorage.getItem('hasCar') === 'true'
    };
  }

  // OAuth Configuration
  var login_path = "/one-thing"
  var redirect_uri = "https://my.globio.io/oauth/account"
  var xano_oauth_init_url = "https://xu8w-at8q-hywg.n7d.xano.io/api:U0aE1wpF/oauth/google/init"
  var xano_oauth_continue_url = "https://xu8w-at8q-hywg.n7d.xano.io/api:U0aE1wpF/oauth/google/continue"
  var formHeaders = [];
  var formResponse = [];
  var authState = false;

  // OAuth Functions
  function initOauth() {
    var fetchURL = new URL(xano_oauth_init_url);
    fetchURL.searchParams.set("redirect_uri", redirect_uri);
    fetchURL = fetchURL.toString();

    fetch(fetchURL, {
        headers: formHeaders,
        method: "GET"
    })
    .then(res => res.json())
    .then(data => formResponse = data)
    .then(() => loginResponse(formResponse))
    .catch((error) => {
        console.error('Error:', error);
    });
  }

  function loginResponse(res) {
    window.location.href = res.authUrl
  }

  function continueOauth(code) {
    var fetchURL = new URL(xano_oauth_continue_url);
    fetchURL.searchParams.set("redirect_uri", redirect_uri);
    fetchURL.searchParams.set("code", code);

    fetchURL = fetchURL.toString();

    fetch(fetchURL, {
        headers: formHeaders,
        method: "GET"
    })
    .then(res => res.json())
    .then(data => formResponse = data)
    .then(() => saveToken(formResponse))
    .catch((error) => {
        console.error('Error:', error);
    });
  }

  function saveToken(res) {
    window.localStorage.setItem('auth', JSON.stringify(res));
    window.localStorage.setItem('reloadAccountOnce', 'true');
    updateAuthState(res);
  }

  function updateAuthState(res) {
    // Update UI with user data
    if (res.name && document.getElementById('user-name')) {
      document.getElementById('user-name').textContent = res.name;
    }
    if (res.email && document.getElementById('user-email')) {
      document.getElementById('user-email').textContent = res.email;
    }
    if (res.picture && document.getElementById('user-photo')) {
      document.getElementById('user-photo').src = res.picture;
    }
    
    // Set userId for the app
    if (res.id) {
      localStorage.setItem('userId', res.id);
      console.log('✅ OAuth: Set userId from token:', res.id);
    }
  }

  // OAuth Event Handlers
  document.addEventListener("click", function(event) {
    if (event.target.classList.contains("authButton")) {
      event.preventDefault();
      initOauth();
    }
  });

  // Legacy logout handler (keeping for compatibility)
  var logoutButton = document.querySelector("#logout");
  if (logoutButton) {
    logoutButton.addEventListener("click", (event) => {
      event.preventDefault();
      performLogout();
    });
  }

  // Auto Reload After Authentication
  (function() {
    // Если только что был reload — ничего не делаем, сбрасываем флаг
    if (localStorage.getItem('justReloaded')) {
      localStorage.removeItem('justReloaded');
      return;
    }

    let alreadyReloaded = false;

    function pollAuthToken() {
      if (alreadyReloaded) return;
      const authRaw = localStorage.getItem('auth');
      if (authRaw) {
        alreadyReloaded = true;
        localStorage.setItem('justReloaded', 'true');
        location.reload();
      } else {
        setTimeout(pollAuthToken, 200); // Проверяем каждые 200мс
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      pollAuthToken();
    });

    // Сбросить флаг при логауте
    window.addEventListener('storage', function(e) {
      if (e.key === 'auth' && !e.newValue) {
        localStorage.removeItem('justReloaded');
      }
    });
  })();

  // Handle OAuth Callback on Page Load
  window.addEventListener('load', function() {
    var curUrl = new URL(document.location.href);
    var code = curUrl.searchParams.get("code");
    if (code) {
      console.log('🔍 OAuth callback detected, processing code:', code);
      
      // Immediately clean URL to hide OAuth parameters from user
      var cleanUrl = new URL(document.location.href);
      cleanUrl.searchParams.delete("code");
      cleanUrl.searchParams.delete("scope");
      cleanUrl.searchParams.delete("authuser");
      cleanUrl.searchParams.delete("hd");
      cleanUrl.searchParams.delete("prompt");
      history.replaceState(null, "", cleanUrl.toString());
      
      continueOauth(code);
    } else {
      var token = window.localStorage.getItem('auth');
      if (token) {
        try {
          token = JSON.parse(token);
          if (token) {
            updateAuthState(token);
          }
        } catch (e) {
          console.error('Error parsing auth token:', e);
        }
      }

      if (!token && curUrl.pathname.indexOf('account') !== -1) {
        document.location.href = login_path;
      }
    }
  });

  const API_SUGGEST = 'https://xu8w-at8q-hywg.n7d.xano.io/api:WT6s5fz4/get_card';
  const API_SAVE = 'https://xu8w-at8q-hywg.n7d.xano.io/api:WT6s5fz4/one_thing_users_cards';
  const API_USERS = 'https://xu8w-at8q-hywg.n7d.xano.io/api:WT6s5fz4/one_thing_users';
  const API_SET_CARD_PUBLISH = 'https://xu8w-at8q-hywg.n7d.xano.io/api:WT6s5fz4/set_card_param'
  const API_SET_CARD_UPLOAD_IMAGE = 'https://xu8w-at8q-hywg.n7d.xano.io/api:WT6s5fz4/upload/image'
  const MAX_ATTEMPTS = 3;
  const EXPIRY_MS = 30 * 24 * 60 * 60 * 1000; // 30 days

  let attemptsLeft = parseInt(localStorage.getItem('attemptsLeftAccount')) || MAX_ATTEMPTS;
  let resetTime = parseInt(localStorage.getItem('resetTimeAccount')) || getMidnightTimestamp();
//    let savedCards = JSON.parse(localStorage.getItem('savedCards')) || [];

  var savedCards = [];
  var completedCards = [];
  var publicCards = [];

  const savedButton = document.querySelector('button[data-filter="saved"]');
  const completedButton = document.querySelector('button[data-filter="completed"]');
  const communityButton = document.querySelector('button[data-filter="community"]');

  var uploadFileName = '';


  // Function to ensure userId is set in localStorage
  function ensureUserId() {
    let userId = localStorage.getItem('userId');

    if (!userId) {
      // Try to get from auth object
      const auth = localStorage.getItem('auth');
      if (auth) {
        try {
          const authObj = JSON.parse(auth);
          if (authObj.id) {
            userId = authObj.id;
            localStorage.setItem('userId', userId);
            console.log('✅ Set userId from auth object:', userId);
          }
        } catch (e) {
          console.error('Error parsing auth object:', e);
        }
      }
    }

    return userId;
  }








  let currentSuggestion = null;
  let currentCategoryFilter = localStorage.getItem('currentCategoryFilter') || 'all';
  let currentTypeFilter = localStorage.getItem('currentTypeFilter') || 'saved';

  const btn = document.getElementById('one-thing-btn');
  const attemptsCounter = document.getElementById('attempts-counter');
  const popup = document.getElementById('one-thing-popup');
  const popupTitle = document.getElementById('popup-title');
  const popupDesc = document.getElementById('popup-desc');
  const btnSave = document.getElementById('popup-save');
  const btnSkip = document.getElementById('popup-skip');
  const cardList = document.getElementById('one-thing-card-list');
  const filterButtons = document.querySelectorAll('.filter-buttons button');
  const filterButtonsDropdown = document.querySelectorAll('.filter-buttons dropdown-container button');
  const filterButtonsGroup = document.querySelectorAll('.filter-buttons .filter-group button');


  console.log('filterButtonsDropdown', filterButtonsDropdown);
  console.log('filterButtonsGroup', filterButtonsGroup);



  // Ensure userId is set через 5 сек
  setTimeout(() => {
    ensureUserId();
  }, 5000);


  updateCounterUI();

  // Restore active state for filter buttons
//    filterButtons.forEach(btn => {
//      btn.classList.remove('active');
//      if (btn.getAttribute('data-filter') === currentTypeFilter) {
//        btn.classList.add('active');
//      }
//    });

  // Remove active class from all filter buttons first
  filterButtons.forEach(btn => {
    btn.classList.remove('active');
  });

  // Set active class based on currentTypeFilter
  console.log('🔍 Setting active tab for currentTypeFilter:', currentTypeFilter);
  filterButtons.forEach(btn => {
    if (btn.getAttribute('data-filter') === currentTypeFilter) {
      btn.classList.add('active');
      console.log('🔍 Activated button:', btn.getAttribute('data-filter'));
    }
  });

  // Load appropriate cards based on current filter
  if (currentTypeFilter === 'saved') {
      loadSavedUserCards();
  }
  if (currentTypeFilter === 'completed') {
      loadCompletedUserCards();
  }
  if (currentTypeFilter === 'community') {
      loadCommunityUserCards();
  }

  renderCardList(currentTypeFilter, currentCategoryFilter); // Start with saved cards by default

  // Initialize dropdown functionality
  initializeDropdown();

  // PROGRESS BAR COMPONENT JS - START (can be easily removed)
  // Progress Bar and Levels System
  const levels = [
    { level: 1, name: "Explorer", xp: 0, description: "Just starting your journey" },
    { level: 2, name: "Adventurer", xp: 100, description: "Taking your first steps" },
    { level: 3, name: "Discoverer", xp: 250, description: "Finding your way around" },
    { level: 4, name: "Explorer", xp: 500, description: "Getting comfortable with exploration" },
    { level: 5, name: "Navigator", xp: 1000, description: "Confidently exploring new places" },
    { level: 6, name: "Pioneer", xp: 2000, description: "Leading the way for others" },
    { level: 7, name: "Trailblazer", xp: 4000, description: "Creating new paths" },
    { level: 8, name: "Master Explorer", xp: 8000, description: "Expert in exploration" },
    { level: 9, name: "Legend", xp: 15000, description: "A true exploration legend" },
    { level: 10, name: "Myth", xp: 30000, description: "The ultimate exploration myth" }
  ];

  let userXP = 0;
  let currentLevel = 1;

  // Calculate user XP based on activities
  function calculateUserXP() {
    const savedCount = savedCards.length;
    const completedCount = completedCards.length;
    const publicCount = completedCards.filter(card => card.published).length;
    
    console.log('🔍 Card counts:', { savedCount, completedCount, publicCount });
    
    // XP calculation: 10 for saved, 25 for completed, 50 for public
    userXP = (savedCount * 10) + (completedCount * 25) + (publicCount * 50);
    
    console.log('🔍 Calculated XP:', userXP);
    
    // Find current level
    for (let i = levels.length - 1; i >= 0; i--) {
      if (userXP >= levels[i].xp) {
        currentLevel = levels[i].level;
        break;
      }
    }
    
    console.log('🔍 Current level:', currentLevel);
    
    return { xp: userXP, level: currentLevel };
  }

  // Update progress counters
  function updateProgressCounters() {
    console.log('🔍 Updating progress counters...');
    
    // Get saved cards count
    const savedCards = JSON.parse(localStorage.getItem('savedUserCards') || '[]');
    const savedCount = savedCards.length;
    
    // Get completed cards count
    const completedCards = JSON.parse(localStorage.getItem('completedUserCards') || '[]');
    const completedCount = completedCards.length;
    
    // Get published cards count (completed cards that are published)
    const publishedCount = completedCards.filter(card => card.published).length;
    
    console.log('🔍 Card counts:', { savedCount, completedCount, publishedCount });
    
    // Update counter elements
    const savedCounter = document.getElementById('saved-counter');
    const completedCounter = document.getElementById('completed-counter');
    const publishedCounter = document.getElementById('published-counter');
    
    if (savedCounter) savedCounter.textContent = savedCount;
    if (completedCounter) completedCounter.textContent = completedCount;
    if (publishedCounter) publishedCounter.textContent = publishedCount;
    
    console.log('✅ Progress counters updated');
  }

  // Update progress bar
  function updateProgressBar() {
    console.log('🔍 Updating progress bar...');
    const progress = calculateUserXP();
    console.log('🔍 User progress:', progress);
    
    const currentLevelData = levels.find(l => l.level === progress.level);
    const nextLevelData = levels.find(l => l.level === progress.level + 1);
    
    console.log('🔍 Level data:', { currentLevelData, nextLevelData });
    
    if (!currentLevelData) {
      console.error('❌ Current level data not found!');
      return;
    }
    
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const progressAvatar = document.getElementById('progress-avatar');
    const savedCounter = document.getElementById('saved-counter');
    const completedCounter = document.getElementById('completed-counter');
    const publishedCounter = document.getElementById('published-counter');
    const roleAchievementLabel = document.getElementById('role-achievement-label');
    const roleBadge = document.getElementById('role-badge');
    
    if (!progressBar || !progressFill || !progressAvatar || !savedCounter || !completedCounter || !publishedCounter || !roleAchievementLabel || !roleBadge) return;
    
    // Update role achievement label
    roleAchievementLabel.textContent = currentLevelData.name;
    
    // Update role badge based on current level
    const badgeUrls = {
      1: 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68b4962706ed934b893dd109_adaptio.svg',
      2: 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68b49627c06a7b55c4c17e8c_expert.svg',
      3: 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68b496275f324ac3f37cb913_mentor.svg',
      4: 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68b49627f74d369d667bff72_ambassadoe.svg'
    };
    
    if (badgeUrls[progress.level]) {
      roleBadge.src = badgeUrls[progress.level];
    }
    
    // Update counters
    updateProgressCounters();
    
    // Update level badge in profile menu
    const levelBadge = document.getElementById('user-level-badge');
    if (levelBadge) {
      levelBadge.textContent = currentLevelData.name;
    }
    
    // Update progress fill
    if (nextLevelData) {
      const currentLevelXP = currentLevelData.xp;
      const nextLevelXP = nextLevelData.xp;
      const progressPercent = ((progress.xp - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100;
      progressFill.style.width = Math.min(progressPercent, 100) + '%';
    } else {
      progressFill.style.width = '100%';
    }
    
    // Update avatar visibility based on progress
    const progressPercent = parseFloat(progressFill.style.width);
    if (progressPercent > 0) {
      progressAvatar.style.opacity = '1';
    } else {
      progressAvatar.style.opacity = '0';
    }
    
    // Avatar is now loaded directly from database in loadUserDataFromXano
  }

  // Show/hide progress bar based on scroll
  function handleScroll() {
    // Try multiple selectors for user avatar/menu
    const userMenuSection = document.querySelector('.user-menu-section');
    const userProfileAvatar = document.querySelector('.user-profile-avatar');
    const userAvatar = document.querySelector('.user-profile-avatar img');
    const progressBar = document.getElementById('progress-bar');
    
    // Use the first available element
    const targetElement = userMenuSection || userProfileAvatar || userAvatar;
    
    if (!targetElement || !progressBar) {
      console.log('🔍 Scroll handler: Missing elements', { 
        userMenuSection: !!userMenuSection,
        userProfileAvatar: !!userProfileAvatar,
        userAvatar: !!userAvatar,
        progressBar: !!progressBar,
        targetElement: !!targetElement
      });
      return;
    }
    
    const targetRect = targetElement.getBoundingClientRect();
    const isTargetVisible = targetRect.top >= 0 && targetRect.bottom <= window.innerHeight;
    
    console.log('🔍 Scroll handler:', { 
      targetTop: targetRect.top, 
      targetBottom: targetRect.bottom, 
      windowHeight: window.innerHeight,
      isTargetVisible,
      scrollY: window.scrollY
    });
    
    if (!isTargetVisible) {
      progressBar.classList.add('show');
      document.getElementById('progress-overlay').classList.add('show');
      console.log('🔍 Progress bar shown (target not visible)');
    } else {
      progressBar.classList.remove('show');
      document.getElementById('progress-overlay').classList.remove('show');
      console.log('🔍 Progress bar hidden (target visible)');
    }
  }

  // Initialize levels popup
  function initializeLevelsPopup() {
    console.log('🔍 Initializing levels popup...');
    const levelsPopup = document.getElementById('levels-popup');
    const levelsClose = document.getElementById('levels-close');
    const progressBar = document.getElementById('progress-bar');
    
    if (!levelsPopup || !levelsClose || !progressBar) {
      console.log('❌ Missing elements for levels popup');
      return;
    }
    
    // Get current user progress
    const progress = calculateUserXP();
    const currentLevel = progress.level;
    const userXP = progress.xp;
    
    console.log('🔍 Current progress for popup:', { currentLevel, userXP });
    
    // Populate levels list
    const levelsList = document.getElementById('levels-list');
    if (levelsList) {
      levelsList.innerHTML = '';
      
      levels.forEach(level => {
        const levelItem = document.createElement('div');
        levelItem.className = 'level-item';
        
        if (level.level === currentLevel) {
          levelItem.classList.add('current');
        } else if (level.level < currentLevel) {
          levelItem.classList.add('completed');
        }
        
        const nextLevel = levels.find(l => l.level === level.level + 1);
        const xpRequired = nextLevel ? nextLevel.xp - level.xp : 0;
        
        levelItem.innerHTML = `
          <div class="level-avatar" style="background: ${level.level <= currentLevel ? '#B1E530' : '#ccc'}">
            ${level.level}
          </div>
          <div class="level-details">
            <div class="level-name">${level.name}</div>
            <div class="level-description">${level.description}</div>
          </div>
          <div class="level-xp">${xpRequired} XP</div>
        `;
        
        levelsList.appendChild(levelItem);
      });
      
      console.log('✅ Levels list populated with', levels.length, 'levels');
    }
    
    // Update current level info
    const currentLevelData = levels.find(l => l.level === currentLevel);
    const nextLevelData = levels.find(l => l.level === currentLevel + 1);
    
    if (currentLevelData) {
      const currentLevelName = document.getElementById('current-level-name');
      const currentLevelProgress = document.getElementById('current-level-progress');
      const levelsAvatar = document.getElementById('levels-avatar');
      
      if (currentLevelName) currentLevelName.textContent = currentLevelData.name;
      if (currentLevelProgress) {
        const progressText = nextLevelData ? 
          `${userXP - currentLevelData.xp} / ${nextLevelData.xp - currentLevelData.xp} XP` : 
          'Max Level';
        currentLevelProgress.textContent = progressText;
      }
      
      // Update circular progress
      const progressRing = document.querySelector('.progress-ring-circle');
      if (progressRing) {
        const progressPercent = nextLevelData ? 
          Math.min(((userXP - currentLevelData.xp) / (nextLevelData.xp - currentLevelData.xp)) * 100, 100) : 
          100;
        const circumference = 2 * Math.PI * 35; // radius = 35
        const offset = circumference - (progressPercent / 100) * circumference;
        progressRing.style.strokeDashoffset = offset;
      }
      
      console.log('✅ Current level info updated:', currentLevelData.name);
    }
    
    // Event listeners
    levelsClose.addEventListener('click', () => {
      levelsPopup.classList.remove('show');
    });
    
    levelsPopup.addEventListener('click', (e) => {
      if (e.target === levelsPopup) {
        levelsPopup.classList.remove('show');
      }
    });
    
    console.log('✅ Levels popup initialized successfully');
  }

  // Initialize progress bar system
  function initializeProgressBar() {
    console.log('🔍 Initializing progress bar system...');
    
    // Check if elements exist
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const levelLabel = document.getElementById('level-label');
    const progressAvatar = document.getElementById('progress-avatar');
    
    console.log('🔍 Progress bar elements found:', {
      progressBar: !!progressBar,
      progressFill: !!progressFill,
      levelLabel: !!levelLabel,
      progressAvatar: !!progressAvatar
    });
    
    if (!progressBar) {
      console.error('❌ Progress bar element not found!');
      return;
    }
    
    updateProgressBar();
    initializeLevelsPopup();
    
    // Add single scroll listener with simple logic
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      scrollTimeout = setTimeout(() => {
        const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
        const threshold = 100; // Show progress bar after 100px scroll
        
        console.log('🔍 Scroll detected:', { scrollY, threshold });
        
        if (scrollY > threshold) {
          progressBar.classList.add('show');
          document.getElementById('progress-overlay').classList.add('show');
          console.log('🔍 Progress bar shown (scroll threshold reached)');
        } else {
          progressBar.classList.remove('show');
          document.getElementById('progress-overlay').classList.remove('show');
          console.log('🔍 Progress bar hidden (scroll threshold not reached)');
        }
      }, 50);
    });
    
    // Show startup progress bar only on first visit (like car cold start)
    console.log('🔍 Checking if this is first visit...');
    const hasSeenStartup = localStorage.getItem('hasSeenStartup');
    
    if (!hasSeenStartup) {
      console.log('🔍 First visit detected - showing startup progress bar');
      progressBar.classList.add('show');
      document.getElementById('progress-overlay').classList.add('show');
      
      // Mark that user has seen the startup sequence
      localStorage.setItem('hasSeenStartup', 'true');
      
      setTimeout(() => {
        progressBar.classList.remove('show');
        document.getElementById('progress-overlay').classList.remove('show');
        console.log('🔍 Startup progress bar completed - will not show again');
      }, 3000);
    } else {
      console.log('🔍 Returning user - skipping startup progress bar');
    }
    
    console.log('✅ Progress bar system initialized');
    
    // Development helper: Reset startup flag (uncomment for testing)
    // localStorage.removeItem('hasSeenStartup');
    
  // Add overlay click handler to close progress bar
  const progressOverlay = document.getElementById('progress-overlay');
  if (progressOverlay) {
    progressOverlay.addEventListener('click', () => {
      progressBar.classList.remove('show');
      progressOverlay.classList.remove('show');
      console.log('🔍 Progress bar closed by overlay click');
    });
  }
    
    // Add level badge click handler
    const levelBadge = document.getElementById('user-level-badge');
    if (levelBadge) {
      levelBadge.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent dropdown from opening
        console.log('🔍 Level badge clicked - showing progress bar');
        progressBar.classList.add('show');
        document.getElementById('progress-overlay').classList.add('show');
        setTimeout(() => {
          progressBar.classList.remove('show');
          document.getElementById('progress-overlay').classList.remove('show');
          console.log('🔍 Progress bar hidden after 5 seconds');
        }, 5000);
      });
    }

    // Add more details button click handler
    const moreDetailsBtn = document.getElementById('more-details-btn');
    if (moreDetailsBtn) {
      moreDetailsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('🔍 More Details button clicked - opening levels popup');
        // Re-initialize popup to ensure fresh data
        initializeLevelsPopup();
        const levelsPopup = document.getElementById('levels-popup');
        if (levelsPopup) {
          levelsPopup.classList.add('show');
        }
      });
    }

    
    // Update progress when cards change
    const originalLoadSavedUserCards = loadSavedUserCards;
    const originalLoadCompletedUserCards = loadCompletedUserCards;
    
    loadSavedUserCards = function() {
      originalLoadSavedUserCards.call(this);
      updateProgressBar();
    };
    
    loadCompletedUserCards = function() {
      originalLoadCompletedUserCards.call(this);
      updateProgressBar();
    };
  }
  // PROGRESS BAR COMPONENT JS - END

  // Initialize event listeners when DOM is ready
  function initializeEventListeners() {
    // Initialize the UI
    updateCounterUI();
    
    // Initialize progress bar system
    initializeProgressBar();

    // Restore active state for filter buttons
//      filterButtons.forEach(btn => {
//        btn.classList.remove('active');
//        if (btn.getAttribute('data-filter') === currentTypeFilter) {
//          btn.classList.add('active');
//        }
//      });


      filterButtonsDropdown.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-filter') === currentTypeFilter) {
          btn.classList.add('active');
        }
      });
      filterButtonsGroup.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-filter') === currentTypeFilter) {
          btn.classList.add('active');
        }
      });

    // Load all card types
    loadSavedUserCards();
    loadCompletedUserCards();
    loadCommunityUserCards();
    
    renderCardList(currentTypeFilter, currentCategoryFilter);

    // Confirmation popup handlers
    const cancelBtn = document.getElementById('confirmation-cancel');
    const confirmBtn = document.getElementById('confirmation-confirm');

    if (cancelBtn) {
      cancelBtn.addEventListener('click', hideConfirmationPopup);
    } else {
      console.error('Confirmation cancel button not found');
    }

    if (confirmBtn) {
      confirmBtn.addEventListener('click', () => {
        const popup = document.getElementById('confirmation-popup');
        const cardId = popup.dataset.cardId;
        const action = popup.dataset.action;

        console.log('🔍 Confirmation button clicked:', action, 'for card:', cardId);

        if (cardId && action) {

          if (action === 'make-public') {
            console.log('🔍 Calling makeCardPublic for card:', cardId);
            makeCardPublic(cardId);
            hideConfirmationPopup();
            // Reload page to show updated state
            setTimeout(() => {
              location.reload();
            }, 500);
          } else if (action === 'make-private') {
            console.log('🔍 Calling makeCardPrivate for card:', cardId);
            makeCardPrivate(cardId);
            hideConfirmationPopup();
            // Reload page to show updated state
            setTimeout(() => {
              location.reload();
            }, 500);
          }
        } else {
          console.error('Missing cardId or action:', { cardId, action });
        }
      });
    }

    // Close confirmation popup when clicking outside
    const confirmationPopup = document.getElementById('confirmation-popup');
    if (confirmationPopup) {
      confirmationPopup.addEventListener('click', (e) => {
        if (e.target === confirmationPopup) {
          hideConfirmationPopup();
        }
      });
    }

    // Referral popup handlers
    const copyBtn = document.getElementById('copy-referral-btn');
    const referralCloseBtn = document.getElementById('referral-close');
    const referralPopup = document.getElementById('referral-popup');

    if (copyBtn) {
      copyBtn.addEventListener('click', copyReferralLink);
    }
    if (referralCloseBtn) {
      referralCloseBtn.addEventListener('click', hideReferralPopup);
    }
    if (referralPopup) {
      referralPopup.addEventListener('click', (e) => {
        if (e.target === referralPopup) {
          hideReferralPopup();
        }
      });
    }

    // Community empty state popup handlers
    const copyCommunityBtn = document.getElementById('copy-community-referral-btn');
    const communityCloseBtn = document.getElementById('community-popup-close');
    const communityPopup = document.getElementById('community-empty-popup');

    if (copyCommunityBtn) {
      copyCommunityBtn.addEventListener('click', copyCommunityReferralLink);
    }
    if (communityCloseBtn) {
      communityCloseBtn.addEventListener('click', hideCommunityEmptyPopup);
    }
    if (communityPopup) {
      communityPopup.addEventListener('click', (e) => {
        if (e.target === communityPopup) {
          hideCommunityEmptyPopup();
        }
      });
    }
  }

  // Initialize event listeners when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEventListeners);
  } else {
    initializeEventListeners();
  }

  btn.addEventListener('click', () => {
    if (attemptsLeft <= 0) return;
    btn.classList.add('loading');
    startLoadingAnimation();
    const context = window.getUserContext ? window.getUserContext() : {};
    let qs = '?';
    for (const key in context) {
      if (context.hasOwnProperty(key)) qs += encodeURIComponent(key) + '=' + encodeURIComponent(context[key]) + '&';
    }
    fetch(API_SUGGEST + qs, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json', 'one-thing-session-id': generateUUID() }
    })
      .then(res => res.json())
      .then(data => {
        btn.classList.remove('loading');
        stopLoadingAnimation();

        console.log('API response debug:', data);

        currentSuggestion = {
          id: data.id || data.card_id || data.cardId || data.card?.id || data.item?.id || data.thing?.id || data.name || 'generated-' + Date.now(),
          title: data.title || data.name || 'No Tip This Time',
          description: data.description || 'Sometimes even the best advice needs a rest. Come back later.',
          category: data.category || data.card?.category || data.item?.category || data.thing?.category || 'places'
        };

        console.log('Current suggestion debug:', currentSuggestion);

        showPopup(currentSuggestion);
      })
      .catch(err => {
        btn.classList.remove('loading');
        stopLoadingAnimation();
        console.error(err);
      });
  });

  btnSave.addEventListener('click', () => {
    if (!currentSuggestion) return;
    const userId = ensureUserId();
    console.log('currentSuggestion', currentSuggestion);

    if (userId && currentSuggestion.id) {
      fetch(API_SAVE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ one_thing_users_id: userId, one_thing_cards_id: currentSuggestion.id, expired_at: Date.now() + 1000 * 60 * 60 * 24 * 30 })
      })
      .then(response => {
        return response.json();
      })
      .then(data => {
//            console.log("RFEFRESH");
          loadSavedUserCards();
          // Show success tooltip
          showSavedSuccessTooltip();
      })
      .catch(err => console.error(err));
    }

    console.log('test');
    // Add expiry timestamp with default image
//      savedCards.unshift({
//        ...currentSuggestion,
//        imageSrc: 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68ad7aea3e7e2dcd1b6e8350_add-photo.avif',
//        expiresAt: Date.now() + EXPIRY_MS
//      });

//      loadSavedUserCards();

    decrementAttempts();

    // Switch to Saved tab and update UI
//      filterButtons.forEach(b => b.classList.remove('active'));
//      const savedButton = document.querySelector('button[data-filter="saved"]');
//      if (savedButton) {
//        savedButton.classList.add('active');
//      }

    filterButtons.forEach(b => b.classList.remove('active'));
    const savedButton = document.querySelector('button[data-filter="saved"]');
    if (savedButton) {
      savedButton.classList.add('active');
    }

    renderCardList('saved', currentCategoryFilter);
    hidePopup();
  });

  btnSkip.addEventListener('click', () => {
    decrementAttempts();

    console.log('BUTTON SKIP - skipping without switching tabs');

    // Just hide the popup without switching tabs
    hidePopup();
  });

//    filterButtons.forEach(btn => {
//      btn.addEventListener('click', () => {
//        console.log('BUTTON FILTER');
//        console.log('filterButtons = ', filterButtons);
//        filterButtons.forEach(b => b.classList.remove('active'));
//
//
//        btn.classList.add('active');
//        currentTypeFilter = btn.getAttribute('data-filter');
//
//        console.log('SET FILTER', currentTypeFilter);
//
//        localStorage.setItem('currentTypeFilter', currentTypeFilter);
//        renderCardList(currentTypeFilter, currentCategoryFilter);
//      });
//    });


  filterButtonsGroup.forEach(btn => {
    btn.addEventListener('click', () => {
      console.log('BUTTON FILTER GROUP');
      console.log('filterButtons group = ', filterButtons);
      
      // Remove active class from all filter buttons
      filterButtons.forEach(b => b.classList.remove('active'));

      btn.classList.add('active');
      currentTypeFilter = btn.getAttribute('data-filter');

      console.log('SET FILTER', currentTypeFilter);
      localStorage.setItem('currentTypeFilter', currentTypeFilter);
      renderCardList(currentTypeFilter, currentCategoryFilter);
    });
  });

  filterButtonsDropdown.forEach(btn => {
    btn.addEventListener('click', () => {
      console.log('BUTTON FILTER dropdown');
      console.log('filterButtons dropdown = ', filterButtonsDropdown);
      
      // Remove active class from all filter buttons
      filterButtons.forEach(b => b.classList.remove('active'));

      btn.classList.add('active');
      currentTypeFilter = btn.getAttribute('data-filter');

      console.log('SET FILTER', currentTypeFilter);

      localStorage.setItem('currentTypeFilter', currentTypeFilter);
      renderCardList(currentTypeFilter, currentCategoryFilter);
    });
  });

  // Remove ability to close popup by clicking outside or escape key
  // User must choose either Save or Skip to proceed

  function showPopup(card) {
    // Set category and icon based on card data
    const category = card.category || 'places'; // Default to places if not specified
    const categoryText = getCategoryText(category);
    const categoryIcon = getCategoryIcon(category);

    console.log('Popup category debug:', {
      originalCategory: card.category,
      finalCategory: category,
      categoryText: categoryText,
      pillClass: 'popup-category-pill ' + category
    });

    // Update popup content
    const categoryPill = document.getElementById('popup-category');
    const categoryTextElement = document.getElementById('popup-category-text');
    const categoryImage = document.getElementById('popup-category-image');

    categoryTextElement.textContent = categoryText;
    categoryImage.src = categoryIcon;
    popupTitle.textContent = card.title;
    popupDesc.textContent = card.description;

    // Update pill classes based on category
    const categoryClass = category.toLowerCase().replace(/\s+/g, '-');
    categoryPill.className = 'popup-category-pill ' + categoryClass;

    // Ensure popup is positioned correctly
    const popupElement = document.getElementById('one-thing-popup');
    popupElement.style.position = 'fixed';
    popupElement.style.top = '0';
    popupElement.style.left = '0';
    popupElement.style.width = '100vw';
    popupElement.style.height = '100vh';
    popupElement.style.zIndex = '999999';

    // Show popup with animation
    popup.classList.add('show');
  }

  function hidePopup() {
    popup.classList.remove('show');
    currentSuggestion = null;
  }

  function getCategoryText(category) {
    const categories = {
      'places': 'Places',
      'daily': 'Daily Things',
      'local': 'Local Context',
      'DAILY THINGS': 'Daily Things',
      'PLACES': 'Places',
      'LOCAL CONTEXT': 'Local Context',
      'DAILY': 'Daily Things',
      'LOCAL': 'Local Context',
      'DAILY-THINGS': 'Daily Things',
      'LOCAL-CONTEXT': 'Local Context'
    };
    return categories[category] || category || 'Places';
  }

  function getCategoryIcon(category) {
    const icons = {
      'places': 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68baa92fd867e721bb77eeda_places-wc.avif',
      'daily': 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68baa92a8316dd46343eceb7_daily-things-wc.avif',
      'local': 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68baa92c7d59117cf84b0aac_local-context-wc.avif',
      'DAILY THINGS': 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68baa92a8316dd46343eceb7_daily-things-wc.avif',
      'PLACES': 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68baa92fd867e721bb77eeda_places-wc.avif',
      'LOCAL CONTEXT': 'https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68baa92c7d59117cf84b0aac_local-context-wc.avif'
    };
    return icons[category] || icons['places'];
  }

  function decrementAttempts() {
    attemptsLeft--;
    localStorage.setItem('attemptsLeftAccount', attemptsLeft);
    localStorage.setItem('resetTimeAccount', resetTime);
    updateCounterUI();
  }
  // Loading phrases for dynamic text
  const loadingPhrases = [
    "Gathering one thing...",
    "Asking locals for secrets...",
    "Digging for hidden gems...",
    "Searching cozy nooks...",
    "Extracting calm in chaos...",
    "Sneaking past tourist traps..."
  ];

  let currentLoadingIndex = 0;
  let loadingInterval = null;

  function updateCounterUI() {
    const oneThingBtn = document.getElementById('one-thing-btn');

    if (attemptsLeft > 0) {
      attemptsCounter.textContent = `${attemptsLeft} / ${MAX_ATTEMPTS} left today`;
      attemptsCounter.classList.remove('no-attempts');
      oneThingBtn.classList.remove('inactive');
    } else {
      attemptsCounter.textContent = `Next in: ${getTimeLeft()}`;
      attemptsCounter.classList.add('no-attempts');
      oneThingBtn.classList.add('inactive');
    }
  }

  function startLoadingAnimation() {
    currentLoadingIndex = 0;
    attemptsCounter.textContent = loadingPhrases[0];
    attemptsCounter.classList.remove('no-attempts');

    loadingInterval = setInterval(() => {
      currentLoadingIndex = (currentLoadingIndex + 1) % loadingPhrases.length;
      attemptsCounter.textContent = loadingPhrases[currentLoadingIndex];
    }, 2000);
  }

  function stopLoadingAnimation() {
    if (loadingInterval) {
      clearInterval(loadingInterval);
      loadingInterval = null;
    }
    updateCounterUI();
  }
  function getMidnightTimestamp() {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).getTime();
  }
  function getTimeLeft() {
    const dist = resetTime - Date.now();
    if (dist <= 0) {
      resetTime = getMidnightTimestamp();
      attemptsLeft = MAX_ATTEMPTS;
      localStorage.setItem('attemptsLeftAccount', attemptsLeft);
      localStorage.setItem('resetTimeAccount', resetTime);
      return '00h 00m';
    }
    const h = Math.floor(dist / (1000 * 60 * 60));
    const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
    return `${h}h ${m}m`;
  }
  function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  function showSuccessTooltip() {
    const tooltip = document.getElementById('success-tooltip');
    if (tooltip) {
      tooltip.classList.add('show');
      console.log('Success tooltip shown');

      setTimeout(() => {
        tooltip.classList.remove('show');
        console.log('Success tooltip hidden');
      }, 3000);
    } else {
      console.error('Success tooltip element not found');
    }
  }

  function showPublicSuccessTooltip() {
    console.log('🔍 showPublicSuccessTooltip called');
    const tooltip = document.getElementById('public-success-tooltip');
    console.log('🔍 Tooltip element found:', !!tooltip);
    if (tooltip) {
      tooltip.classList.add('show');
      console.log('✅ Public success tooltip shown');

      setTimeout(() => {
        tooltip.classList.remove('show');
        console.log('✅ Public success tooltip hidden');
      }, 3000);
    } else {
      console.error('❌ Public success tooltip element not found');
    }
  }

  function showPrivateSuccessTooltip() {
    console.log('🔍 showPrivateSuccessTooltip called');
    const tooltip = document.getElementById('private-success-tooltip');
    console.log('🔍 Tooltip element found:', !!tooltip);
    if (tooltip) {
      tooltip.classList.add('show');
      console.log('✅ Private success tooltip shown');

      setTimeout(() => {
        tooltip.classList.remove('show');
        console.log('✅ Private success tooltip hidden');
      }, 3000);
    } else {
      console.error('❌ Private success tooltip element not found');
    }
  }

  function showSavedSuccessTooltip() {
    console.log('🔍 showSavedSuccessTooltip called');
    const tooltip = document.getElementById('saved-success-tooltip');
    console.log('🔍 Tooltip element found:', !!tooltip);
    if (tooltip) {
      tooltip.classList.add('show');
      console.log('✅ Saved success tooltip shown');

      setTimeout(() => {
        tooltip.classList.remove('show');
        console.log('✅ Saved success tooltip hidden');
      }, 3000);
    } else {
      console.error('❌ Saved success tooltip element not found');
    }
  }

  function showCopyErrorTooltip() {
    const tooltip = document.getElementById('copy-error-tooltip');
    if (tooltip) {
      tooltip.classList.add('show');
      console.log('Copy error tooltip shown');

      setTimeout(() => {
        tooltip.classList.remove('show');
        console.log('Copy error tooltip hidden');
      }, 3000);
    } else {
      console.error('Copy error tooltip element not found');
    }
  }

  function showHeicErrorTooltip() {
    const tooltip = document.getElementById('heic-error-tooltip');
    if (tooltip) {
      tooltip.classList.add('show');
      console.log('HEIC error tooltip shown');

      setTimeout(() => {
        tooltip.classList.remove('show');
        console.log('HEIC error tooltip hidden');
      }, 3000);
    } else {
      console.error('HEIC error tooltip element not found');
    }
  }

  function showLocationErrorTooltip(message) {
    const tooltip = document.getElementById('location-error-tooltip');
    if (tooltip) {
      const tooltipText = tooltip.querySelector('span');
      if (tooltipText) {
        tooltipText.textContent = message;
      }
      tooltip.classList.add('show');
      console.log('Location error tooltip shown');

      setTimeout(() => {
        tooltip.classList.remove('show');
        console.log('Location error tooltip hidden');
      }, 3000);
    } else {
      console.error('Location error tooltip element not found');
    }
  }

  function showLocationSuccessTooltip() {
    const tooltip = document.getElementById('location-success-tooltip');
    if (tooltip) {
      tooltip.classList.add('show');
      console.log('Location success tooltip shown');

      setTimeout(() => {
        tooltip.classList.remove('show');
        console.log('Location success tooltip hidden');
      }, 3000);
    } else {
      console.error('Location success tooltip element not found');
    }
  }

  function showContextSuccessTooltip() {
    const tooltip = document.getElementById('context-success-tooltip');
    if (tooltip) {
      tooltip.classList.add('show');
      console.log('Context success tooltip shown');
      setTimeout(() => {
        tooltip.classList.remove('show');
      }, 3000);
    }
  }

  function showConfirmationPopup(one_thing_user_card_id, action) {
//      console.log('showConfirmationPopup called:', cardId, action);

    // Look for card in both savedCards and completedCards
    let card = savedCards.find(c => c.one_thing_user_card_id === one_thing_user_card_id);
    if (!card) {
      card = completedCards.find(c => c.one_thing_user_card_id === one_thing_user_card_id);
    }
    if (!card) {
      console.log('Card not found in savedCards or completedCards:', one_thing_user_card_id);
      console.log('savedCards:', savedCards.map(c => ({ id: c.one_thing_user_card_id, type: c.type })));
      console.log('completedCards:', completedCards.map(c => ({ id: c.one_thing_user_card_id, type: c.type })));
      return;
    }

    const titleEl = document.getElementById('confirmation-title');
    const descriptionEl = document.getElementById('confirmation-description');
    const confirmBtn = document.getElementById('confirmation-confirm');

    console.log('Found elements:', { titleEl: !!titleEl, descriptionEl: !!descriptionEl, confirmBtn: !!confirmBtn });

    if (action === 'make-public') {
      titleEl.textContent = 'Make Thing Public?';
      descriptionEl.textContent = 'This will make your completed thing visible to the community. Other users will be able to see and get inspired by your experience.';
      confirmBtn.textContent = 'Make Thing Public';
    } else if (action === 'make-private') {
      titleEl.textContent = 'Make Thing Private?';
      descriptionEl.innerHTML = 'Are you sure you want to remove this from the community? <br><br><strong>Your experience could inspire others!</strong> 🌟<br><br>By keeping it public, you\'re helping create a vibrant community of people sharing their adventures and discoveries.';
      confirmBtn.textContent = 'Make Private';
    }

    // Store the card ID and action for confirmation
    const popup = document.getElementById('confirmation-popup');
    if (popup) {
      popup.dataset.cardId = one_thing_user_card_id;
      popup.dataset.action = action;
      popup.classList.add('show');
      console.log('Popup shown with data:', { one_thing_user_card_id, action });
      console.log('Popup dataset after setting:', popup.dataset);
    } else {
      console.error('Confirmation popup element not found');
    }
  }

  function hideConfirmationPopup() {
    document.getElementById('confirmation-popup').classList.remove('show');
    delete document.getElementById('confirmation-popup').dataset.cardId;
    delete document.getElementById('confirmation-popup').dataset.action;
  }

  // Global functions for empty state buttons
  function scrollToGetOneThing() {
    console.log('🔍 scrollToGetOneThing() called - scrolling to top');
    // Scroll to top of page
    window.scrollTo({ 
      top: 0, 
      behavior: 'smooth' 
    });
    console.log('✅ Scroll command executed');
  }

  function showReferralPopup() {
    const userId = ensureUserId();
    const referralCode = userId ? userId.substring(0, 8) : 'YOURCODE';

    document.getElementById('referral-code').textContent = referralCode;
    document.getElementById('referral-popup').classList.add('show');
  }

  function hideReferralPopup() {
    document.getElementById('referral-popup').classList.remove('show');
  }

  function copyReferralLink() {
    const userId = ensureUserId();
    const referralCode = userId ? userId.substring(0, 8) : 'YOURCODE';
    const fullLink = `https://globio.io/ref/${referralCode}`;

    navigator.clipboard.writeText(fullLink).then(() => {
      const copyBtn = document.getElementById('copy-referral-btn');
      copyBtn.textContent = 'Copied!';
      copyBtn.classList.add('copied');

      setTimeout(() => {
        copyBtn.textContent = 'Copy';
        copyBtn.classList.remove('copied');
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy: ', err);
      showCopyErrorTooltip();
    });
  }

  function showCommunityEmptyPopup() {
    const userId = ensureUserId();
    const referralCode = userId ? userId.substring(0, 8) : 'YOURCODE';

    document.getElementById('community-referral-code').textContent = referralCode;
    document.getElementById('community-empty-popup').classList.add('show');
  }

  function hideCommunityEmptyPopup() {
    document.getElementById('community-empty-popup').classList.remove('show');
  }

  function copyCommunityReferralLink() {
    const userId = ensureUserId();
    const referralCode = userId ? userId.substring(0, 8) : 'YOURCODE';
    const fullLink = `https://globio.io/ref/${referralCode}`;

    navigator.clipboard.writeText(fullLink).then(() => {
      const copyBtn = document.getElementById('copy-community-referral-btn');
      copyBtn.textContent = 'Copied!';
      copyBtn.classList.add('copied');

      setTimeout(() => {
        copyBtn.textContent = 'Copy';
        copyBtn.classList.remove('copied');
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy: ', err);
      showCopyErrorTooltip();
    });
  }

  function makeCardPublic(cardId) {
    console.log('🔍 makeCardPublic called with cardId:', cardId);
    cardId = parseInt(cardId);
    // Look for card in both savedCards and completedCards
    let card = savedCards.find(c => c.one_thing_user_card_id == cardId);
    if (!card) {
      card = completedCards.find(c => c.one_thing_user_card_id == cardId);
    }
    if (!card) {
      console.error('❌ Error makeCardPublic: card not found in savedCards or completedCards');
      console.log('savedCards:', savedCards.map(c => ({ id: c.one_thing_user_card_id, type: c.type })));
      console.log('completedCards:', completedCards.map(c => ({ id: c.one_thing_user_card_id, type: c.type })));
      return;
    }
    const userId = ensureUserId();
    const requestBody = {
      one_thing_user_card_id: cardId,
      published: true,
      completed: true,
      published_at: Date.now()
    };
    console.log('🔍 Making card public:', { cardId, card: card.one_thing_user_card_id, type: card.type });
    makeApiCall(requestBody, card);
    loadCommunityUserCards();
  }

   function makeCardCompleted(one_thing_user_card_id) {
      const userId = ensureUserId();

      console.log('one_thing_user_card_id', one_thing_user_card_id);
      console.log('savedCards', savedCards);
      
      // Find the card in savedCards
      const cardIndex = savedCards.findIndex(c => c.one_thing_user_card_id == one_thing_user_card_id);
      if (cardIndex === -1) {
          console.log('Error makeCardCompleted: card not found');
          return;
      }
      
      const card = savedCards[cardIndex];
      
      // Update the card type to completed
      card.type = 'completed';
      card.completed = true;
      card.completed_at = Date.now();
      
      // Remove from savedCards array
      savedCards.splice(cardIndex, 1);
      
      // Add to completedCards array
      completedCards.push(card);
      
      console.log('Card moved to completedCards:', card);
      console.log('savedCards length after removal:', savedCards.length);
      console.log('completedCards length after addition:', completedCards.length);
      
      const requestBody = {
          one_thing_user_card_id: one_thing_user_card_id,
          completed: true,
          published: false,
          completed_at: Date.now()
      };
      
      makeApiCall(requestBody, card);
      
      // Set currentTypeFilter to completed for next page load
      localStorage.setItem('currentTypeFilter', 'completed');
      
      // Refresh both saved and completed lists
      loadSavedUserCards();
      loadCompletedUserCards();
  }

  function makeApiCall(requestBody, card) {
    fetch(API_SET_CARD_PUBLISH, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestBody)
    })
      .then(response => {
        if (!response.ok) {
          console.error('❌ API response not ok:');
          throw new Error(`Failed to update card: ${response.status} ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('✅ API call successful:', data);
        
        // If this was a completion request, the card is already moved in makeCardCompleted
        if (requestBody.completed) {
          console.log('🎉 Card completed successfully!');
        } else if (requestBody.published !== undefined) {
          // This was a publish/unpublish request
          
          // Update the card status in the appropriate array
          let cardToUpdate = savedCards.find(c => c.one_thing_user_card_id == requestBody.one_thing_user_card_id);
          if (!cardToUpdate) {
            cardToUpdate = completedCards.find(c => c.one_thing_user_card_id == requestBody.one_thing_user_card_id);
          }
          
          if (cardToUpdate) {
            cardToUpdate.published = requestBody.published;
            console.log('✅ Updated card status in array:', { 
              cardId: requestBody.one_thing_user_card_id, 
              published: requestBody.published,
              cardType: cardToUpdate.type 
            });
          }
          
          // Update the toggle label and state without re-rendering the entire list
          console.log('🔍 Looking for toggle with ID:', `#toggle-${cardToUpdate.id}`);
          const toggle = document.querySelector(`#toggle-${cardToUpdate.id}`);
          console.log('🔍 Toggle found:', !!toggle);
          if (toggle) {
            toggle.disabled = false;
            toggle.checked = requestBody.published;
            console.log('🔍 Toggle state updated to:', requestBody.published);
            
            // Update the toggle label
            const toggleContainer = toggle.closest('.toggle-container');
            if (toggleContainer) {
              const toggleLabel = toggleContainer.querySelector('.toggle-label');
              if (toggleLabel) {
                toggleLabel.textContent = requestBody.published ? 'Public' : 'Make Public';
                console.log('✅ Updated toggle label to:', toggleLabel.textContent);
              }
            }
            
            console.log('✅ Updated toggle state and label for card:', requestBody.one_thing_user_card_id);
          } else {
            console.log('⚠️ Toggle not found for card:', requestBody.one_thing_user_card_id);
            console.log('⚠️ Available toggles:', document.querySelectorAll('input[type="checkbox"]').length);
          }

          // Update publicCards if card was published/unpublished
          if (requestBody.published) {
            // Add card to publicCards if it's not already there
            const existingPublicCard = publicCards.find(pc => pc.one_thing_user_card_id == requestBody.one_thing_user_card_id);
            if (!existingPublicCard && cardToUpdate) {
              const publicCard = {
                ...cardToUpdate,
                type: 'community',
                published_at: Date.now()
              };
              publicCards.unshift(publicCard); // Add to beginning of array
              console.log('✅ Added card to publicCards:', publicCard.one_thing_user_card_id);
            }
          } else {
            // Remove card from publicCards if it was unpublished
            const publicCardIndex = publicCards.findIndex(pc => pc.one_thing_user_card_id == requestBody.one_thing_user_card_id);
            if (publicCardIndex !== -1) {
              publicCards.splice(publicCardIndex, 1);
              console.log('✅ Removed card from publicCards:', requestBody.one_thing_user_card_id);
            }
          }
          
          // Show appropriate success tooltip
          console.log('🔍 About to show tooltip, requestBody.published:', requestBody.published);
          if (requestBody.published) {
            console.log('🔍 Calling showPublicSuccessTooltip');
            showPublicSuccessTooltip();
          } else {
            console.log('🔍 Calling showPrivateSuccessTooltip');
            showPrivateSuccessTooltip();
          }
          console.log('🎉 Successfully updated card publish state!');
          
          // Update the current view to reflect changes without reloading
          renderCardList(currentTypeFilter, currentCategoryFilter);
        }
      })
      .catch(error => {
        console.error('❌ Error updating card:', error);
        console.error('❌ Error details:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });

        // If this was a publish request, re-enable toggle on error
        if (requestBody.published !== undefined) {
          // Find the card again for error handling
          let cardToUpdate = savedCards.find(c => c.one_thing_user_card_id == requestBody.one_thing_user_card_id);
          if (!cardToUpdate) {
            cardToUpdate = completedCards.find(c => c.one_thing_user_card_id == requestBody.one_thing_user_card_id);
          }
          
          if (cardToUpdate) {
            const toggle = document.querySelector(`#toggle-${cardToUpdate.id}`);
          if (toggle) {
            toggle.disabled = false;
            toggle.checked = !requestBody.published; // Reset to previous state
            
            // Reset the toggle label to previous state
            const toggleContainer = toggle.closest('.toggle-container');
            if (toggleContainer) {
              const toggleLabel = toggleContainer.querySelector('.toggle-label');
              if (toggleLabel) {
                toggleLabel.textContent = !requestBody.published ? 'Public' : 'Make Public';
                console.log('🔄 Reset toggle label to:', toggleLabel.textContent);
              }
            }
            
            console.log('🔄 Reset toggle to previous state due to error');
          }
          }
        }
      });
  }

  function makeCardPrivate(cardId) {
      cardId = parseInt(cardId);
      // Look for card in both savedCards and completedCards
      let card = savedCards.find(c => c.one_thing_user_card_id == cardId);
      if (!card) {
        card = completedCards.find(c => c.one_thing_user_card_id == cardId);
      }
      if (!card) {
        console.error('Error makeCardPrivate: card not found in savedCards or completedCards');
        console.log('savedCards:', savedCards.map(c => ({ id: c.one_thing_user_card_id, type: c.type })));
        console.log('completedCards:', completedCards.map(c => ({ id: c.one_thing_user_card_id, type: c.type })));
        return;
      }
      const userId = ensureUserId();
      const requestBody = {
        one_thing_user_card_id: cardId,
        published: false,
        completed: true,
        published_at: null
      };
      console.log('Making card private:', { cardId, card: card.one_thing_user_card_id, type: card.type });
      makeApiCall(requestBody, card);
      loadCommunityUserCards();
  }

  function uploadFile(file) {
      const formData = new FormData();
      formData.append("workspace_id", "1-0"); // ← сюда свой ID воркспейса
      formData.append("type", "image"); // можно "attachment", "video", "audio"
      formData.append("content", file);

      return fetch(API_SET_CARD_UPLOAD_IMAGE, {
          method: 'POST',
          headers: {
          },
          body: formData
      })
     .then(response => {
       return response.json();
     })
     .then(data => {
       const imagePath = data.path;
       return imagePath;
     })
      .catch(error => {
        console.error('❌ Error making card public:', error);
      });
};

  function renderCardList(filter = 'all', categoryFilter = 'all') {
    // Add fade out effect
    cardList.style.opacity = '0.7';
    cardList.style.transform = 'scale(0.98)';
    cardList.style.transition = 'all 0.2s ease';

    setTimeout(() => {
      cardList.innerHTML = '';
      // Remove expired cards
      const now = Date.now();
      savedCards = savedCards.filter(card => card.expiresAt > now);
      completedCards = completedCards.filter(card => card.expiresAt > now);

      let toShow = [];




      // Filter by type (saved/completed/community)
      if (filter === 'saved') {
        toShow = toShow.concat(savedCards);
      } else if (filter === 'completed') {
        toShow = toShow.concat(completedCards);
      } else if (filter === 'community') {
        toShow = toShow.concat(publicCards || []);
      } else if (filter === 'all') {
        // For 'all' filter, combine all card types
        toShow = toShow.concat(savedCards);
        toShow = toShow.concat(completedCards);
        toShow = toShow.concat(publicCards || []);
      }





      console.log('🔍 renderCardList called with filter:', filter);
      console.log('🔍 to show', toShow);
      console.log('🔍 to categoryFilter', categoryFilter);
      console.log('🔍 savedCards length:', savedCards.length);
      console.log('🔍 completedCards length:', completedCards.length);
      console.log('🔍 publicCards length:', (publicCards || []).length);

      // Filter by category
//        if (categoryFilter !== 'all') {
//          toShow = toShow.filter(card => card.category === categoryFilter);
//        }

      if (categoryFilter === 'daily') {
          toShow = toShow.filter(card => card.category == "DAILY THINGS");
      }

      if (categoryFilter === 'places') {
          toShow = toShow.filter(card => card.category == "PLACES");
      }

      if (categoryFilter === 'local') {
          toShow = toShow.filter(card => card.category == "LOCAL CONTEXT");
      }

      if (toShow.length === 0) {
        let emptyStateHtml = '';

        if (filter === 'saved') {
          emptyStateHtml = `
        <div class="empty-state">
          <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68949b2379142ee1bc95f3f2_6cd31bde078d550f5278843c00331b47_no-things-yet.svg" alt="">
          <h3>No saved things yet</h3>
          <p>This space will become a reflection of your progress, unique discoveries, and the helpful advice you've gathered along the way.</p>
          <button class="empty-state-btn" onclick="scrollToGetOneThing()">Get One Thing</button>
        </div>`;
        } else if (filter === 'completed') {
          emptyStateHtml = `
        <div class="empty-state">
          <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68949b2379142ee1bc95f3f2_6cd31bde078d550f5278843c00331b47_no-things-yet.svg" alt="">
          <h3>No completed things yet</h3>
          <p>This space will become a reflection of your progress, unique discoveries, and the helpful advice you've gathered along the way.</p>
          <button class="empty-state-btn" onclick="scrollToGetOneThing()">Get One Thing</button>
        </div>`;
        } else if (filter === 'community') {
          emptyStateHtml = `
        <div class="empty-state">
          <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6894a725c6e8a617ce6d1fe2_no-things-community.svg" alt="">
          <h3>No community contributions yet</h3>
          <p>Here you'll see all the things completed by the Globio community in your area—helpful tips and experiences, tailored to your current location.</p>
          <button class="empty-state-btn" onclick="showCommunityEmptyPopup()">Invite a Friend</button>
        </div>`;
        } else {
          emptyStateHtml = `
        <div class="empty-state">
          <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68949b2379142ee1bc95f3f2_6cd31bde078d550f5278843c00331b47_no-things-yet.svg" alt="">
          <h3>No saved things yet</h3>
          <p>This space will become a reflection of your progress, unique discoveries, and the helpful advice you've gathered along the way.</p>
          <button class="empty-state-btn" onclick="scrollToGetOneThing()">Get One Thing</button>
        </div>`;
        }

        cardList.innerHTML = emptyStateHtml;
        return;
      }
      toShow.forEach((card, idx) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'one-thing-card';
        let expiryHtml = '';
        if (card.type === 'saved') {
          const daysLeft = Math.ceil((card.expiresAt - now) / (1000 * 60 * 60 * 24));
          let urgencyClass = '';
          if (daysLeft === 1) {
            urgencyClass = ' critical';
          } else if (daysLeft <= 3) {
            urgencyClass = ' warning';
          }
          expiryHtml = `<div class="card-expiry${urgencyClass}">${daysLeft} day${daysLeft === 1 ? '' : 's'} left</div>`;
        }
        let toggleHtml = '';

        if (card.type === 'completed') {
          toggleHtml = `
        <div class="toggle-container">
          <span class="toggle-label">${card.published ? 'Public' : 'Make Public'}</span>
          <div class="toggle-switch">
            <input type="checkbox" id="toggle-${card.id}" ${card.published ? 'checked' : ''}>
            <label class="toggle-slider" for="toggle-${card.id}"></label>
          </div>
        </div>
      `;
        }

        // Get category text
        console.log('🔍 Card category debug:', {
          cardId: card.id,
          cardCategory: card.category,
          cardTitle: card.title,
          cardType: card.type
        });
        const categoryText = getCategoryText(card.category);

        // Check if the image is the default add-photo icon
        const isDefaultImage = card.imageSrc.includes('add-photo');

        // Create expiry HTML or complete button based on image state
        let actionHtml = '';

        if (card.type === 'saved') {
          if (isDefaultImage) {
            // Show expiry counter for cards without photos
            const daysLeft = Math.ceil((card.expiresAt - Date.now()) / (1000 * 60 * 60 * 24));
            let urgencyClass = '';
            if (daysLeft === 1) {
              urgencyClass = ' critical';
            } else if (daysLeft <= 3) {
              urgencyClass = ' warning';
            }
            actionHtml = `<div class="card-expiry${urgencyClass}">${daysLeft} day${daysLeft === 1 ? '' : 's'} left</div>`;
          } else {
            // Show complete button for cards with photos
            actionHtml = `<button class="complete-thing-btn" data-card-id="${card.one_thing_user_card_id}">Complete Thing</button>`;
          }
        } else if (card.type === 'completed') {
          // For completed cards, no action button needed - just show the image
          actionHtml = '';
        } else {
          actionHtml = expiryHtml;
        }

        // Add author name and avatar for community cards
        let authorHtml = '';
        if (card.type === 'community') {
          const authorName = card.author_name || card.user_name || 'User';
          const authorAvatar = card.author_avatar;
          
          if (authorAvatar) {
            authorHtml = `
              <div class="card-author">
                <img src="${authorAvatar}" alt="${authorName}" class="author-avatar" width="20" height="20" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.marginLeft='0';">
                <span>by ${authorName}</span>
              </div>`;
          } else {
            authorHtml = `<div class="card-author">by ${authorName}</div>`;
          }
        }

        // Create different HTML for saved vs completed cards
        let imageHtml = '';
        if (card.type === 'saved') {
          // For saved cards, show interactive image upload
          imageHtml = `
      <div class="card-image-placeholder">
        <img src="${card.imageSrc}" alt="Card image" class="${isDefaultImage ? 'add-photo-icon' : 'uploaded-image'}" style="display: ${isDefaultImage ? 'none' : 'block'}" data-card-id="${card.id}" 
             onerror="this.src='https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68ad7aea3e7e2dcd1b6e8350_add-photo.avif'; this.className='add-photo-icon'; this.style.display='block'; this.nextElementSibling.style.display='none';">
        <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68ad7aea3e7e2dcd1b6e8350_add-photo.avif"
             alt="Add photo"
             class="add-photo-icon"
             style="display: ${isDefaultImage ? 'block' : 'none'}"
             data-card-id="${card.id}">
        <input type="file" accept="image/*,.heic,.heif" data-card-id="${card.id}">
        <div class="image-upload-loader" data-card-id="${card.id}">
          <div class="spinner"></div>
          <div class="loading-text">Uploading image...</div>
        </div>
      </div>`;
        } else if (card.type === 'completed') {
          // For completed cards, show static image only
          imageHtml = `
      <div class="card-image-placeholder">
        <img src="${card.imageSrc}" alt="Card image" class="uploaded-image" style="display: block;" data-card-id="${card.id}" 
             onerror="this.src='https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68ad7aea3e7e2dcd1b6e8350_add-photo.avif'">
      </div>`;
        } else {
          // For community cards, show static image
          imageHtml = `
      <div class="card-image-placeholder">
        <img src="${card.imageSrc}" alt="Card image" class="uploaded-image" style="display: block;" data-card-id="${card.id}" 
             onerror="this.src='https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68ad7aea3e7e2dcd1b6e8350_add-photo.avif'">
      </div>`;
        }

        cardEl.innerHTML = `
      <div class="card-category-tag ${card.category || 'PLACES'}">${categoryText}</div>
      ${imageHtml}
      <h4>${card.title}</h4>
      <p>${card.description}</p>
      ${actionHtml}
      ${toggleHtml}
      ${authorHtml}
    `;
        // Add image upload functionality only for saved cards
        if (card.type === 'saved') {
          const placeholder = cardEl.querySelector('.card-image-placeholder');
          const img = cardEl.querySelector(`img[data-card-id="${card.id}"][alt="Card image"]`);
          const addPhotoIcon = cardEl.querySelector(`img[data-card-id="${card.id}"].add-photo-icon`);
          const input = cardEl.querySelector(`input[data-card-id="${card.id}"]`);

          // Set initial classes based on image state
          if (isDefaultImage) {
            img.className = 'add-photo-icon';
          } else {
            img.className = 'uploaded-image';
          }

//            console.log('Setting up image upload for card:', card.id, 'elements found:', {
//              img: !!img,
//              addPhotoIcon: !!addPhotoIcon,
//              input: !!input
//            });

          input.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
              var userCardId = card.one_thing_user_card_id;

               uploadFile(file)
                 .then(function(imagePath) {
                  uploadFileName = imagePath;
                   const requestBody = {
                     one_thing_user_card_id: userCardId,
                     image: imagePath
                   };

                   return makeApiCall(requestBody, card);
                 })
                 .then(function(response) {
                   console.log("✅ Всё прошло успешно", response);
                 })
                 .catch(function(error) {
                   console.error("❌ Ошибка:", error);
                 });







              // Show loader
              const loader = cardEl.querySelector(`.image-upload-loader[data-card-id="${card.id}"]`);
              const startTime = Date.now();
              const minLoadTime = 1000; // Minimum 1 second

              if (loader) {
                loader.classList.add('show');
              }

              // Function to process image (either HEIC or regular image)
              const processImage = (imageBlob) => {
                const reader = new FileReader();
                reader.onload = ev => {
                  console.log('File processed for card:', card.id);

                  // Calculate how long the loader should be shown
                  const elapsedTime = Date.now() - startTime;
                  const remainingTime = Math.max(0, minLoadTime - elapsedTime);

                  setTimeout(() => {
                    // Hide loader
                    if (loader) {
                      loader.classList.remove('show');
                    }

                    // Update image
                    img.src = ev.target.result;
                    img.className = 'uploaded-image';
                    img.style.display = 'block';
                    addPhotoIcon.style.display = 'none';

                    if (card.type === 'saved') {
                      // Update the card's image in saved cards
                      const savedIndex = savedCards.findIndex(c => c.id === card.id);
                      if (savedIndex !== -1) {
                        console.log('Updating saved card image:', card.id);
                        savedCards[savedIndex].imageSrc = ev.target.result;
//                          try {
//                            localStorage.setItem('savedCards', JSON.stringify(savedCards));
//                          } catch (e) {
//                            // Clear old data and try again
//                            localStorage.clear();
//                            localStorage.setItem('savedCards', JSON.stringify(savedCards));
//                          }

                        // Re-render the list to show the complete button
                        renderCardList(currentTypeFilter, currentCategoryFilter);
                      } else {
                        console.error('Saved card not found:', card.id);
                      }
                    }
                  }, remainingTime);
                };

                reader.onerror = () => {
                  console.error('Error reading file for card:', card.id);
                  if (loader) {
                    loader.classList.remove('show');
                  }
                };

                reader.readAsDataURL(imageBlob);
              };

              // Check if file is HEIC/HEIF format
              const isHeic = file.name.toLowerCase().endsWith('.heic') ||
                file.name.toLowerCase().endsWith('.heif') ||
                file.type === 'image/heic' ||
                file.type === 'image/heif';

              if (isHeic && typeof heic2any !== 'undefined') {
                console.log('Converting HEIC file to JPEG for card:', card.id);

                // Convert HEIC to JPEG
                heic2any({
                  blob: file,
                  toType: 'image/jpeg',
                  quality: 0.8
                }).then(convertedBlob => {
                  console.log('HEIC converted successfully for card:', card.id);
                  processImage(convertedBlob);
                }).catch(error => {
                  console.error('Error converting HEIC file for card:', card.id, error);
                  if (loader) {
                    loader.classList.remove('show');
                  }
                  showHeicErrorTooltip();
                });
              } else {
                // Process regular image file
                console.log('Processing regular image file for card:', card.id);
                processImage(file);
              }
            }
          });
        }

        // Add complete button functionality
        const completeBtnPopup = cardEl.querySelector('.complete-thing-btn');
        if (completeBtnPopup) {
          completeBtnPopup.addEventListener('click', () => {
            if (card.type === 'saved') {
              console.log('complete-thing-btn clicked');

              makeCardCompleted(card.one_thing_user_card_id);

              // Show success tooltip
              showSuccessTooltip();

              // Reload page to show updated state and switch to Completed tab
              setTimeout(() => {
                location.reload();
              }, 1000);
            }
          });
        }

        // Add toggle switch functionality for completed cards
        if (card.type === 'completed') {
          const toggle = cardEl.querySelector('input[type="checkbox"]');
          if (toggle) {
            toggle.addEventListener('change', (e) => {
              console.log('🔍 Toggle change event triggered');
              console.log('🔍 Toggle checked:', e.target.checked);
              console.log('🔍 Card published:', card.published);
              console.log('🔍 Card ID:', card.id);
              console.log('🔍 Card one_thing_user_card_id:', card.one_thing_user_card_id);
              
              // Disable toggle during API call
              toggle.disabled = true;

              if (e.target.checked && !card.published) {
                // Making public
                console.log('🔍 Making public - showing confirmation for card:', card.id);
                showConfirmationPopup(card.one_thing_user_card_id, 'make-public');
              } else if (!e.target.checked && card.published) {
                // Making private
                console.log('🔍 Making private - showing confirmation for card:', card.id);
                showConfirmationPopup(card.one_thing_user_card_id, 'make-private');
              } else {
                console.log('🔍 No action needed - toggle state matches public state');
              }

              // Reset the toggle to current state until confirmed with smooth animation
              setTimeout(() => {
                e.target.checked = card.published;
                toggle.disabled = false;
                console.log('Reset toggle for card:', card.id, 'to:', card.published);
              }, 150);
            });
          }
        }

        cardList.appendChild(cardEl);
      });

      // Add fade in effect
      setTimeout(() => {
        cardList.style.opacity = '1';
        cardList.style.transform = 'scale(1)';
      }, 50);
    });
  }

  // Update expiry count every hour (refreshes days left)
//    setInterval(() => {
//      renderCardList(currentTypeFilter, currentCategoryFilter);
//    }, 60 * 60 * 1000);
  // Keep attempts counter updated every minute
//    setInterval(() => { if (attemptsLeft <= 0) updateCounterUI(); }, 60000);



//    function loadCards() {
//      if (!currentSuggestion) return;
//      const userId = ensureUserId();
//      if (userId && currentSuggestion.id) {
//        let user = fetch(API_USERS + '/' + userId, {
//          method: 'GET',
//          headers: { 'Content-Type': 'application/json' },
//        }).catch(err => console.error(err));
//      }
//    }



//    // Load public cards from API on initialization
//    function loadUserCards() {
//
//      const userId = ensureUserId();
//      if (!userId) {
//        console.log('No userId found for loadUserCards');
//        return;
//      }
//
//      fetch(API_USERS + '/' + userId)
//        .then(response => {
//          console.log('loadUserCards response status:', response.status);
//          return response.json();
//        })
//        .then(data => {
//          if (data) {
//            const usersCards = data.users_cards.map(item => item.card);
//
//
//
//            console.log('usersCards', usersCards);
//
//            const formattedCards = usersCards.map(card => ({
//              id: card.name, // или card.id, если нужен числовой
//              title: card.name,
//              description: `Discover the ${card.name} in ${card.city}. A great spot for ${card.tags.split(",").join(", ")}.`,
//              category: card.tags.split(",")[0]?.toUpperCase() || "LOCAL CONTEXT",
//              imageSrc: "https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68ad7aea3e7e2dcd1b6e8350_add-photo.avif", // заглушка
//              expiresAt: Date.now() + 1000 * 60 * 60 * 24 * 30 // через 30 дней
//            }));
//
//            savedCards = formattedCards;
//
////            localStorage.setItem('savedCards', JSON.stringify(formattedCards));
//            renderCardList('saved', currentCategoryFilter);
//          }
//        })
//        .catch(error => {
//          console.error('Error loading public cards:', error);
//        });
//    }



  function loadSavedUserCards() {
    const userId = ensureUserId();
    if (!userId) {
      console.log('No userId');
      return;
    }

    fetch(API_USERS + '/' + userId)
      .then(response => {
        console.log('loadUserCards response status:', response.status);
        return response.json();
      })
      .then(data => {
        if (data) {
       var usersCards = data.users_cards
             .filter(item => item.created_at !== null)
             .map(item => ({
               ...item.card,
               expired_at: item.expired_at,
               one_thing_user_card_id: item.id,
               completed: item.completed,
               published: item.published,
               image: item.image,
               created_at: item.created_at
             }))
             .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

          var formattedCards = usersCards
            .filter(card => !card.completed) // Only show non-completed cards in saved
            .map(card => ({
              id: card.id,
              title: card.name,
              description: `Discover the ${card.name} in ${card.city}. A great spot for ${card.tags.split(",").join(", ")}.`,
              category: card.tags.split(",")[0]?.toUpperCase() || "LOCAL CONTEXT",
              imageSrc: card.image ? "https://xu8w-at8q-hywg.n7d.xano.io" + card.image : "https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/68ad7aea3e7e2dcd1b6e8350_add-photo.avif",
              expiresAt: card.expired_at,
              one_thing_user_card_id: card.one_thing_user_card_id,
              completed: card.completed,
              published: card.published,
              type: "saved"
            }));
          savedCards = formattedCards;
          console.log('Saved cards loaded:', savedCards.length, 'cards');
          renderCardList('saved', currentCategoryFilter);
        }
      })
      .catch(error => {
        console.error('Error loading public cards:', error);
      });
  }


   function loadCompletedUserCards() {
        const userId = ensureUserId();
        if (!userId) {
          console.log('No userId');
          return;
        }

        fetch(API_USERS + '/' + userId)
          .then(response => {
            return response.json();
          })
          .then(data => {
            if (data) {
              var usersCards = data.users_cards
                .filter(item => item.completed_at !== null)
                .map(item => ({
                  ...item.card,
                  expired_at: item.expired_at,
                  one_thing_user_card_id: item.id,
                  completed: item.completed,
                  published: item.published,
                  imageSrc: item.image,
                  completed_at: item.completed_at
                }))
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));

              var formattedCards = usersCards
                .filter(card => card.completed) // Only show completed cards
                .map(card => ({
                  id: card.id,
                  title: card.name,
                  description: `Discover the ${card.name} in ${card.city}. A great spot for ${card.tags.split(",").join(", ")}.`,
                  category: card.tags.split(",")[0]?.toUpperCase() || "LOCAL CONTEXT",
                  imageSrc: "https://xu8w-at8q-hywg.n7d.xano.io" + card.imageSrc,
                  expiresAt: card.expired_at,
                  one_thing_user_card_id: card.one_thing_user_card_id,
                  completed: card.completed,
                  published: card.published,
                  type: "completed"
                }));
              completedCards = formattedCards;
              console.log('Completed cards loaded:', completedCards.length, 'cards');
              renderCardList('completed', currentCategoryFilter);
            }
          })
          .catch(error => {
            console.error('Error loading public cards:', error);
          });
  }

   function loadCommunityUserCards() {

        // Get all published cards from all users
        console.log('🔍 Fetching community cards from API...');
        fetch('https://xu8w-at8q-hywg.n7d.xano.io/api:WT6s5fz4/one_thing_users_cards')
          .then(response => {
            return response.json();
          })
          .then(data => {
            console.log('🔍 Community cards data loaded:', data);
            console.log('🔍 First card structure:', data[0]);
            console.log('🔍 All available fields in first card:', Object.keys(data[0] || {}));
            if (data && Array.isArray(data)) {
              // Filter only published cards from all users
              var publishedCards = data
                .filter(item => item.published === true && item.completed === true)
                .sort((a, b) => new Date(b.published_at) - new Date(a.published_at));
                
              console.log('🔍 Published cards found:', publishedCards.length);

              // Get unique user IDs and card IDs to fetch details
              var userIds = [...new Set(publishedCards.map(card => card.one_thing_users_id))];
              var cardIds = [...new Set(publishedCards.map(card => card.one_thing_cards_id))];
              
              console.log('🔍 Unique user IDs:', userIds);
              console.log('🔍 Unique card IDs:', cardIds);
              console.log('🔍 Published cards details:', publishedCards.map(card => ({
                id: card.id,
                one_thing_cards_id: card.one_thing_cards_id,
                one_thing_users_id: card.one_thing_users_id,
                published: card.published,
                completed: card.completed
              })));

              // Fetch only user details (skip card details since they don't exist)
              Promise.all([
                // Fetch all users
                ...userIds.map(userId => 
                  fetch(`https://xu8w-at8q-hywg.n7d.xano.io/api:WT6s5fz4/one_thing_users/${userId}`)
                    .then(response => response.json())
                    .then(userData => ({ userId, userData }))
                )
              ]).then(results => {
                // Process user data only
                var userDataMap = {};
                
                results.forEach(result => {
                  if (result.userId) {
                    userDataMap[result.userId] = result.userData;
                  }
                });

                console.log('🔍 User data map:', userDataMap);

                // Format cards using only publishedCards data (since cardData doesn't exist)
                var formattedCards = publishedCards.map(card => {
                  var userData = userDataMap[card.one_thing_users_id];
                  
                  // Debug logging
                  console.log('🔍 Community card debug:', {
                    cardId: card.one_thing_cards_id,
                    publishedCard: card,
                    allCardFields: Object.keys(card),
                    cardValues: card
                  });
                  
                  // Use fallback data since cardData doesn't exist
                  const cardName = `Community Card ${card.one_thing_cards_id}`;
                  const cardCity = 'your area';
                  const cardTags = 'exploration';
                  const cardCategory = 'PLACES';
                  
                  return {
                    id: card.one_thing_cards_id,
                    title: cardName,
                    description: cardName && cardCity ? 
                      `Discover the ${cardName} in ${cardCity}. A great spot for ${cardTags.split(",").join(", ")}.` : 
                      `A community shared experience`,
                    category: cardCategory,
                    imageSrc: card.image ? "https://xu8w-at8q-hywg.n7d.xano.io" + card.image : "",
                    expiresAt: card.expired_at,
                    one_thing_user_card_id: card.id,
                    completed: card.completed,
                    published: card.published,
                    author_name: userData ? (userData.name || 'User') : `User ${card.one_thing_users_id}`,
                    author_avatar: userData && userData.picture ? (userData.picture.startsWith('http') ? userData.picture : `https://xu8w-at8q-hywg.n7d.xano.io${userData.picture}`) : null,
                    type: "community"
                  };
                });

                publicCards = formattedCards;
                console.log('Community cards loaded with full details:', publicCards.length, 'cards');
              }).catch(error => {
                console.error('Error loading user/card details:', error);
                // Fallback to basic cards if detailed loading fails
                var formattedCards = publishedCards.map(card => ({
                  id: card.one_thing_cards_id,
                  title: `Community Card ${card.id}`,
                  description: `A community shared card from user ${card.one_thing_users_id}`,
                  category: "PLACES",
                  imageSrc: card.image ? "https://xu8w-at8q-hywg.n7d.xano.io" + card.image : "",
                  expiresAt: card.expired_at,
                  one_thing_user_card_id: card.id,
                  completed: card.completed,
                  published: card.published,
                  author_name: `User ${card.one_thing_users_id}`,
                  author_avatar: null,
                  type: "community"
                }));
                publicCards = formattedCards;
                console.log('Community cards loaded (fallback):', publicCards.length, 'cards');
              });
            }
          })
          .catch(error => {
            console.error('Error loading public cards:', error);
          });
      }




  // Removed duplicate event listener - handled by filterButtonsGroup.forEach


  // Removed duplicate event listeners - handled by filterButtonsGroup.forEach






  // All Categories Dropdown Functionality
  function initializeDropdown() {
    const dropdownTrigger = document.getElementById('all-categories-dropdown');
    const dropdownMenu = document.getElementById('categories-dropdown-menu');
    const dropdownItems = dropdownMenu.querySelectorAll('.dropdown-item');

    if (!dropdownTrigger || !dropdownMenu) return;

    // Set initial active state based on saved category filter
    dropdownItems.forEach(item => {
      if (item.getAttribute('data-category') === currentCategoryFilter) {
        item.classList.add('selected');
        dropdownTrigger.querySelector('span').textContent = item.querySelector('span').textContent;
      } else {
        item.classList.remove('selected');
      }
    });

    // Toggle dropdown
    dropdownTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      console.log('Dropdown clicked, current state:', {
        isActive: dropdownTrigger.classList.contains('active'),
        isShow: dropdownMenu.classList.contains('show')
      });

      dropdownTrigger.classList.toggle('active');
      dropdownMenu.classList.toggle('show');

      // Ensure dropdown trigger stays active
      if (!dropdownMenu.classList.contains('show')) {
        dropdownTrigger.classList.add('active');
      }

      console.log('Dropdown state after toggle:', {
        isActive: dropdownTrigger.classList.contains('active'),
        isShow: dropdownMenu.classList.contains('show')
      });
    });

    // Handle dropdown item selection
    dropdownItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        const category = item.getAttribute('data-category');

        // Update dropdown trigger text
        dropdownTrigger.querySelector('span').textContent = item.querySelector('span').textContent;

        // Update active states
        dropdownItems.forEach(i => i.classList.remove('selected'));
        item.classList.add('selected');

console.log('BUTTON DROP down');
        // Close dropdown but keep trigger active
        dropdownTrigger.classList.remove('active');
        dropdownMenu.classList.remove('show');

        // Keep dropdown trigger button always active
        dropdownTrigger.classList.add('active');

        // Update category filter
        currentCategoryFilter = category;
        localStorage.setItem('currentCategoryFilter', category);

        // Trigger filter change using saved type filter
        renderCardList(currentTypeFilter, currentCategoryFilter);
      });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!dropdownTrigger.contains(e.target) && !dropdownMenu.contains(e.target)) {
          console.log('BUTTON CLICK');
        dropdownTrigger.classList.remove('active');
        dropdownMenu.classList.remove('show');

        // Keep dropdown trigger button always active
        dropdownTrigger.classList.add('active');
      }
    });

    // Close dropdown on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
          console.log('BUTTONEscape');
        dropdownTrigger.classList.remove('active');
        dropdownMenu.classList.remove('show');

        // Keep dropdown trigger button always active
        dropdownTrigger.classList.add('active');
      }
    });
  }
})();



</script>

<!-- Footer -->
<footer class="footer">
  <div class="footer-content">
    <div class="footer-left">
      <img src="https://cdn.prod.website-files.com/64d15b8bef1b2f28f40b4f1e/6832d9b8e5b4f439621d5a12_one-thing-by-globio.svg" alt="One Thing by Globio" class="footer-logo">
    </div>
    <div class="footer-right">
      <a href="https://www.globio.io/privacy" target="_blank" rel="noopener noreferrer" class="footer-link">Privacy Policy</a>
      <a href="https://www.globio.io/terms" target="_blank" rel="noopener noreferrer" class="footer-link">Terms and Conditions</a>
      <a href="https://www.globio.io/" target="_blank" rel="noopener noreferrer" class="footer-link">Globio Unity, Inc.</a>
    </div>
  </div>
</footer>

